name: QuantumRoute V6 - Supreme Intelligence (Iran Optimized) - FIXED

on:
  schedule:
    - cron: '0 */3 * * *'
  push:
    branches: ["main"]
  workflow_dispatch:

# âš ï¸ CRITICAL FIX: Add permissions for writing to repository
permissions:
  contents: write
  actions: read

concurrency:
  group: quantum-v6
  cancel-in-progress: true

env:
  OUTPUT_DIR: output
  TIMEOUT_MS: 8000
  MAX_PARALLEL: 40
  MIN_SCORE: 450
  STABILITY_ATTEMPTS: 7
  ENABLE_ML: true
  ENABLE_HONEYPOT_DETECTION: true
  ENABLE_IRAN_OPTIMIZATION: true
  ENABLE_ADVANCED_DPI_EVASION: true
  # NEW: Enhanced features
  ENABLE_AUTO_RETRY: true
  ENABLE_FALLBACK_DNS: true
  ENABLE_LATENCY_OPTIMIZATION: true
  ENABLE_GEO_FILTERING: true

jobs:
  quantum-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: ğŸ“¥ Checkout Repository (Enhanced)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better ML
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install All Dependencies (Enhanced)
        run: |
          set -e  # Exit on error
          sudo apt-get update -qq
          sudo apt-get install -y jq curl netcat-openbsd openssl dnsutils whois traceroute mtr-tiny
          npm init -y
          npm install p-limit node-fetch@2 geoip-lite axios cheerio
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ“ Create Directory Structure (Enhanced)
        run: |
          set -e
          mkdir -p "$OUTPUT_DIR" tmp logs cache history iran_specific backup
          
          # Load previous results for ML
          if [[ -f output/history.json ]]; then
            cp output/history.json cache/history.json
            echo "âœ… ML history loaded"
          fi
          
          # Load previous working configs for comparison
          if [[ -f output/configs.txt ]]; then
            cp output/configs.txt backup/previous_configs.txt
            echo "âœ… Previous configs backed up"
          fi
          
          echo "âœ… Directories created"

      - name: ğŸŒ Fetch Configs from All Sources (Enhanced + Fixed)
        run: |
          set -e
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ QuantumRoute V6 - Supreme Intelligence Fetcher (Enhanced)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          SOURCES=(
            "https://ghproxy.net/https://raw.githubusercontent.com/barry-far/V2ray-Configs/refs/heads/main/All_Configs_Sub.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/85la/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/cfmeme/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/datiya/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/jichangx/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/nodefree/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/oneclash/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/yudou/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/roosterkid/openproxylist/refs/heads/main/V2RAY_RAW.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/roosterkid/openproxylist/refs/heads/main/V2RAY_BASE64.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/all_extracted_configs.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/miladtahanian/V2RayCFGDumper/refs/heads/main/config.txt"
            "https://openproxylist.com/v2ray/rawlist/text"
            "https://openproxylist.com/v2ray/rawlist/subscribe"
            "https://ghproxy.net/https://raw.githubusercontent.com/ShatakVPN/ConfigForge-V2Ray/refs/heads/main/configs/all.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/Epodonios/v2ray-configs/refs/heads/main/All_Configs_Sub.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/itsyebekhe/PSG/main/subscriptions/xray/base64/mix"
          )
          
          # Add Firmfox sources
          for i in $(seq 1 38); do
            SOURCES+=("https://ghproxy.net/https://raw.githubusercontent.com/Firmfox/proxify/main/v2ray_configs/mixed/subscription-${i}.txt")
          done
          
          : > tmp/raw_all.txt
          : > logs/fetch.log
          
          fetch_source() {
            local url="$1"
            local idx="$2"
            local outfile="tmp/src_${idx}.txt"
            
            for attempt in {1..3}; do
              if curl -fsSL --retry 2 --retry-delay 2 --connect-timeout 20 --max-time 60 \
                -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
                "$url" -o "$outfile" 2>/dev/null; then
                
                # Check if base64 encoded
                if [[ -f "$outfile" ]] && file "$outfile" 2>/dev/null | grep -q "ASCII"; then
                  if head -1 "$outfile" 2>/dev/null | grep -qE '^[A-Za-z0-9+/=]{20,}$'; then
                    base64 -d "$outfile" > "${outfile}.dec" 2>/dev/null && mv "${outfile}.dec" "$outfile"
                  fi
                fi
                
                if [[ -f "$outfile" ]]; then
                  local count=$(wc -l < "$outfile" 2>/dev/null || echo 0)
                  echo "âœ… [$idx] $count lines (attempt $attempt)" >> logs/fetch.log
                  cat "$outfile" >> tmp/raw_all.txt 2>/dev/null
                  return 0
                fi
              fi
              sleep 1
            done
            echo "âŒ [$idx] FAILED after 3 attempts" >> logs/fetch.log
            return 1
          }
          
          idx=0
          pids=()
          for url in "${SOURCES[@]}"; do
            fetch_source "$url" "$idx" &
            pids+=($!)
            ((idx++))
            if (( ${#pids[@]} >= 15 )); then
              wait "${pids[0]}" 2>/dev/null || true
              pids=("${pids[@]:1}")
            fi
          done
          
          # Wait for all remaining processes
          for pid in "${pids[@]}"; do
            wait "$pid" 2>/dev/null || true
          done
          
          TOTAL_LINES=$(wc -l < tmp/raw_all.txt 2>/dev/null || echo 0)
          echo "ğŸ“Š Total lines fetched: $TOTAL_LINES"
          
          if [[ $TOTAL_LINES -lt 100 ]]; then
            echo "âŒ ERROR: Insufficient configs fetched (${TOTAL_LINES} < 100)"
            exit 1
          fi

      - name: ğŸ” Parse & Deduplicate (Enhanced)
        run: |
          set -e
          
          echo "ğŸ” Parsing and deduplicating configs..."
          
          # Extract all proxy URLs
          grep -oE '(vmess|vless|trojan|ss|ssr|hysteria|hysteria2|tuic|shadowsocks)://[^[:space:]"<>'"'"']+' tmp/raw_all.txt 2>/dev/null | \
            sed 's/[[:space:]]*$//' | sort -u > tmp/all_configs.txt || true
          
          # Advanced deduplication with hash-based tracking
          declare -A SEEN
          : > tmp/unique.txt
          
          while IFS= read -r line || [[ -n "$line" ]]; do
            [[ -z "$line" || ${#line} -lt 10 ]] && continue
            clean=$(echo "$line" | tr -d '\r\n' | sed 's/[[:space:]]//g')
            hash=$(echo -n "$clean" | sha256sum | cut -d' ' -f1)
            if [[ -z "${SEEN[$hash]:-}" ]]; then
              SEEN[$hash]=1
              echo "$clean" >> tmp/unique.txt
            fi
          done < tmp/all_configs.txt
          
          UNIQUE_COUNT=${#SEEN[@]}
          echo "ğŸ“Š Unique configs: $UNIQUE_COUNT"
          
          if [[ $UNIQUE_COUNT -lt 50 ]]; then
            echo "âŒ ERROR: Too few unique configs (${UNIQUE_COUNT} < 50)"
            exit 1
          fi
          
          echo "âœ… Deduplication complete: $UNIQUE_COUNT unique configs"

      - name: ğŸ§ª V6 Supreme Intelligence Tester (Enhanced)
        run: |
          cat << 'TESTER_V6_ENHANCED_EOF' > tester.js
          const net = require('net');
          const tls = require('tls');
          const https = require('https');
          const http = require('http');
          const fs = require('fs');
          const dns = require('dns');
          const crypto = require('crypto');
          const pLimit = require('p-limit');
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // V6 Enhanced Configuration
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const TIMEOUT = parseInt(process.env.TIMEOUT_MS) || 8000;
          const PARALLEL = parseInt(process.env.MAX_PARALLEL) || 40;
          const MIN_SCORE = parseInt(process.env.MIN_SCORE) || 450;
          const STABILITY_ATTEMPTS = parseInt(process.env.STABILITY_ATTEMPTS) || 7;
          const ENABLE_ML = process.env.ENABLE_ML === 'true';
          const ENABLE_HONEYPOT = process.env.ENABLE_HONEYPOT_DETECTION === 'true';
          const ENABLE_IRAN_OPT = process.env.ENABLE_IRAN_OPTIMIZATION === 'true';
          const ENABLE_DPI_EVASION = process.env.ENABLE_ADVANCED_DPI_EVASION === 'true';
          const ENABLE_AUTO_RETRY = process.env.ENABLE_AUTO_RETRY === 'true';
          const ENABLE_FALLBACK_DNS = process.env.ENABLE_FALLBACK_DNS === 'true';
          const ENABLE_LATENCY_OPT = process.env.ENABLE_LATENCY_OPTIMIZATION === 'true';
          const ENABLE_GEO_FILTER = process.env.ENABLE_GEO_FILTERING === 'true';
          
          const limit = pLimit(PARALLEL);
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced Iran DPI Signatures
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const IRAN_DPI_SIGNATURES = {
            resetPatterns: [
              'HTTP/1.1 403 Forbidden',
              'Connection reset by peer',
              'ECONNRESET',
              'certificate verify failed',
              'ETIMEDOUT',
              'ECONNREFUSED'
            ],
            blockingPatterns: [
              'pars', 'tehran', 'iran', 'ir', 'asiatech', 'mokhaberat',
              'shatel', 'rightel', 'irancell', 'mci', 'tci', 'pishgaman',
              'afranet', 'datak', 'respina', 'fanava', 'sabanet'
            ],
            blockedPorts: [22, 1080, 3128, 8080, 8888, 9050, 10808],
            sniFingerprints: ['cloudflare', 'google', 'amazon', 'microsoft', 'fastly'],
            safeProtocols: ['vless-reality', 'hysteria2', 'tuic'],
            safePorts: [443, 2053, 2083, 2087, 2096, 8443]
          };
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Comprehensive CDN Ranges
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const CDN_RANGES = {
            cloudflare: [
              '103.21.244.', '103.22.200.', '103.31.4.', '104.16.', '104.17.',
              '104.18.', '104.19.', '104.20.', '104.21.', '104.22.', '104.23.',
              '104.24.', '104.25.', '104.26.', '104.27.', '104.28.', '104.29.',
              '104.30.', '104.31.', '108.162.', '131.0.72.', '141.101.',
              '162.158.', '162.159.', '172.64.', '172.65.', '172.66.', '172.67.',
              '173.245.', '188.114.', '190.93.', '197.234.', '198.41.'
            ],
            fastly: ['151.101.', '199.232.', '185.31.', '146.75.'],
            akamai: ['23.', '104.', '184.', '2.16.', '2.17.', '2.18.', '2.19.', '2.20.'],
            amazon: ['52.', '54.', '99.', '13.', '18.', '34.', '35.'],
            google: ['35.', '34.', '8.8.', '8.34.', '8.35.', '142.250.', '172.217.']
          };
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced Protocol Quality Weights
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const PROTOCOL_WEIGHTS = {
            vless: { base: 120, reality_bonus: 200, tls_bonus: 85, ws_bonus: 65, grpc_bonus: 70 },
            vmess: { base: 90, ws_bonus: 75, tls_bonus: 65, cdn_bonus: 55, h2_bonus: 60 },
            trojan: { base: 115, ws_bonus: 70, cdn_bonus: 60, grpc_bonus: 65 },
            hysteria: { base: 105, v2_bonus: 45, obfs_bonus: 50 },
            hysteria2: { base: 140, obfs_bonus: 55, salamander_bonus: 60 },
            tuic: { base: 100, v5_bonus: 50, congestion_bonus: 45 },
            ss: { base: 75, plugin_bonus: 45, aead_bonus: 40 },
            ssr: { base: 65, obfs_bonus: 40, protocol_bonus: 35 },
            shadowsocks: { base: 80, plugin_bonus: 50, aead_bonus: 45 }
          };
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced Port Scoring for Iran
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const PORT_IRAN_SCORES = {
            443: 110,   // HTTPS - Best
            2053: 105,  // Cloudflare HTTPS
            2083: 105,  // Cloudflare HTTPS
            2087: 105,  // Cloudflare HTTPS
            2096: 105,  // Cloudflare HTTPS
            8443: 100,  // Alternative HTTPS
            2096: 95,   // Cloudflare alt
            80: 80,     // HTTP
            2052: 75,   // Cloudflare HTTP
            2082: 75,   // Cloudflare HTTP
            2086: 75,   // Cloudflare HTTP
            2095: 75,   // Cloudflare HTTP
            8080: 45,   // Commonly filtered
            3128: 40,   // Proxy port - filtered
            1080: 25,   // SOCKS - heavily filtered
            8888: 35,   // Often blocked
            default: 60
          };
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // ML History & Statistics
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          let mlHistory = [];
          let successfulHosts = new Map();
          let failedHosts = new Map();
          
          try {
            if (fs.existsSync('cache/history.json')) {
              mlHistory = JSON.parse(fs.readFileSync('cache/history.json', 'utf8'));
              console.log(`ğŸ§  ML history loaded: ${mlHistory.length} records`);
              
              // Build host success/failure maps
              mlHistory.forEach(record => {
                const host = record.host;
                if (record.success) {
                  successfulHosts.set(host, (successfulHosts.get(host) || 0) + 1);
                } else {
                  failedHosts.set(host, (failedHosts.get(host) || 0) + 1);
                }
              });
            }
          } catch (e) {
            console.log('âš ï¸  No ML history found, starting fresh');
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced CDN Detection
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function detectCDN(ip) {
            if (!ip) return null;
            for (const [cdn, prefixes] of Object.entries(CDN_RANGES)) {
              if (prefixes.some(prefix => ip.startsWith(prefix))) {
                return cdn;
              }
            }
            return null;
          }
          
          function getCDNScore(cdn) {
            const scores = {
              cloudflare: 90,
              fastly: 75,
              akamai: 70,
              amazon: 65,
              google: 80
            };
            return scores[cdn] || 0;
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced Iran DPI Risk Calculator
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function calculateIranDPIRisk(config, testResults) {
            let riskScore = 0;
            const risks = [];
            
            // Error pattern analysis
            if (testResults.errors && testResults.errors.length > 0) {
              const errorText = testResults.errors.join(' ').toLowerCase();
              IRAN_DPI_SIGNATURES.resetPatterns.forEach(pattern => {
                if (errorText.includes(pattern.toLowerCase())) {
                  riskScore += 35;
                  risks.push(`DPI_${pattern.substring(0, 15).replace(/\s+/g, '_')}`);
                }
              });
            }
            
            // Port risk assessment
            if (IRAN_DPI_SIGNATURES.blockedPorts.includes(config.port)) {
              riskScore += 50;
              risks.push('HIGH_RISK_PORT');
            } else if (IRAN_DPI_SIGNATURES.safePorts.includes(config.port)) {
              riskScore -= 30;
              risks.push('SAFE_PORT');
            }
            
            // Protocol security
            if (config.reality) {
              riskScore -= 60;
              risks.push('REALITY_PROTECTED');
            } else if (config.protocol === 'hysteria2') {
              riskScore -= 40;
              risks.push('HYSTERIA2_PROTECTED');
            } else if (config.protocol === 'vmess' && !config.tls && !config.ws) {
              riskScore += 45;
              risks.push('NO_ENCRYPTION');
            }
            
            // SNI filtering
            if (config.sni) {
              const sniLower = config.sni.toLowerCase();
              if (IRAN_DPI_SIGNATURES.sniFingerprints.some(fp => sniLower.includes(fp))) {
                riskScore += 25;
                risks.push('SNI_MONITORED');
              }
            }
            
            // CDN protection
            if (config.cdn) {
              riskScore -= getCDNScore(config.cdn) * 0.5;
              risks.push(`CDN_${config.cdn.toUpperCase()}`);
            } else if (config.port === 443 && config.tls) {
              riskScore += 30;
              risks.push('NO_CDN_TLS');
            }
            
            // Historical host performance
            const hostSuccesses = successfulHosts.get(config.host) || 0;
            const hostFailures = failedHosts.get(config.host) || 0;
            if (hostSuccesses > hostFailures * 2) {
              riskScore -= 25;
              risks.push('PROVEN_HOST');
            } else if (hostFailures > hostSuccesses * 2) {
              riskScore += 30;
              risks.push('PROBLEMATIC_HOST');
            }
            
            // Transport layer obfuscation
            if (config.ws || config.grpc || config.h2) {
              riskScore -= 20;
              risks.push('TRANSPORT_OBFS');
            }
            
            // Determine final risk level
            let risk = 'low';
            if (riskScore >= 70) risk = 'high';
            else if (riskScore >= 35) risk = 'medium';
            
            return { 
              risk, 
              score: Math.max(0, Math.min(100, riskScore)), 
              reasons: risks 
            };
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced Honeypot Detection
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function detectHoneypot(config, testResults) {
            const suspicious = [];
            let score = 0;
            
            // Instant response (< 3ms)
            if (testResults.latency && testResults.latency < 3) {
              suspicious.push('INSTANT_RESPONSE');
              score += 35;
            }
            
            // Known honeypot patterns
            const honeypotPatterns = ['test', 'monitor', 'honeypot', 'trap', 'fake', 'decoy', 'bait'];
            if (config.host) {
              const hostLower = config.host.toLowerCase();
              honeypotPatterns.forEach(pattern => {
                if (hostLower.includes(pattern)) {
                  suspicious.push(`PATTERN_${pattern.toUpperCase()}`);
                  score += 40;
                }
              });
            }
            
            // Suspicious ports
            const honeypotPorts = [31337, 12345, 54321, 6666, 6667, 1337, 31338];
            if (honeypotPorts.includes(config.port)) {
              suspicious.push('HONEYPOT_PORT');
              score += 40;
            }
            
            // Always accepts but never transmits
            if (testResults.connected && !testResults.dataTransmitted) {
              suspicious.push('NO_DATA_FLOW');
              score += 50;
            }
            
            // Too many successful connections from same IP
            if (testResults.sameIPCount && testResults.sameIPCount > 100) {
              suspicious.push('SUSPICIOUS_IP_REUSE');
              score += 30;
            }
            
            // Unusual protocol combinations
            if (config.protocol === 'vmess' && config.port === 443 && !config.tls) {
              suspicious.push('INVALID_COMBO');
              score += 35;
            }
            
            return {
              isHoneypot: score >= 65,
              confidence: Math.min(100, score),
              reasons: suspicious
            };
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced ML Confidence Calculator
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function calculateMLConfidence(config, testResults) {
            if (!ENABLE_ML || mlHistory.length < 5) {
              return 50;
            }
            
            // Find similar configs
            const similar = mlHistory.filter(h => {
              const protocolMatch = h.protocol === config.protocol;
              const portClose = Math.abs(h.port - config.port) < 100;
              const cdnMatch = h.cdn === config.cdn;
              const hostMatch = h.host === config.host;
              
              return (protocolMatch && portClose) || hostMatch;
            });
            
            if (similar.length === 0) return 50;
            
            // Calculate metrics
            const successRate = similar.filter(h => h.success).length / similar.length;
            const avgLatency = similar.reduce((sum, h) => sum + (h.latency || 0), 0) / similar.length;
            const recentSuccesses = similar.slice(-10).filter(h => h.success).length;
            
            let confidence = successRate * 50;
            
            // Recent performance bonus
            confidence += (recentSuccesses / 10) * 20;
            
            // Latency consistency
            if (testResults.latency && avgLatency > 0) {
              const latencyDiff = Math.abs(testResults.latency - avgLatency);
              if (latencyDiff < 50) confidence += 15;
              else if (latencyDiff < 100) confidence += 10;
            }
            
            // CDN consistency
            const cdnMatches = similar.filter(h => h.cdn === config.cdn).length;
            if (cdnMatches > similar.length * 0.7) {
              confidence += 15;
            }
            
            return Math.min(100, Math.round(confidence));
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced Config Parser
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function parseConfig(url) {
            try {
              const parts = url.match(/^([^:]+):\/\/(.+)$/);
              if (!parts) return null;
              
              const protocol = parts[1].toLowerCase();
              const data = parts[2];
              
              const config = { protocol, raw: url };
              
              if (protocol === 'vmess') {
                const json = JSON.parse(Buffer.from(data, 'base64').toString());
                config.host = json.add || json.host;
                config.port = parseInt(json.port);
                config.id = json.id;
                config.net = json.net;
                config.type = json.type;
                config.tls = json.tls === 'tls';
                config.sni = json.sni || json.host;
                config.ws = json.net === 'ws';
                config.grpc = json.net === 'grpc';
                config.h2 = json.net === 'h2';
                config.cdn = json.net === 'ws' && json.host !== json.add;
                config.path = json.path;
              } else if (protocol === 'vless' || protocol === 'trojan') {
                const [auth, rest] = data.split('@');
                if (!rest) return null;
                const [hostPort, params] = rest.split('?');
                const [host, port] = hostPort.split(':');
                
                config.host = host;
                config.port = parseInt(port);
                config.id = auth;
                
                if (params) {
                  const urlParams = new URLSearchParams(params);
                  config.security = urlParams.get('security');
                  config.tls = ['tls', 'reality'].includes(config.security);
                  config.reality = config.security === 'reality';
                  config.sni = urlParams.get('sni');
                  config.type = urlParams.get('type');
                  config.ws = config.type === 'ws';
                  config.grpc = config.type === 'grpc';
                  config.h2 = config.type === 'h2';
                  config.flow = urlParams.get('flow');
                  config.pbk = urlParams.get('pbk');
                  config.sid = urlParams.get('sid');
                }
              } else if (['hysteria', 'hysteria2', 'hy2'].includes(protocol)) {
                const [auth, rest] = data.split('@');
                if (!rest) return null;
                const [hostPort, params] = rest.split('?');
                const [host, port] = hostPort.split(':');
                
                config.host = host;
                config.port = parseInt(port);
                config.auth = auth;
                
                if (params) {
                  const urlParams = new URLSearchParams(params);
                  config.obfs = urlParams.get('obfs');
                  config.obfsPassword = urlParams.get('obfs-password');
                }
              } else if (['ss', 'shadowsocks'].includes(protocol)) {
                const [auth, hostPort] = data.split('@');
                if (!hostPort) return null;
                const [host, port] = hostPort.split(':');
                config.host = host;
                config.port = parseInt(port);
                config.method = auth;
              } else if (protocol === 'tuic') {
                const [auth, rest] = data.split('@');
                if (!rest) return null;
                const [hostPort, params] = rest.split('?');
                const [host, port] = hostPort.split(':');
                
                config.host = host;
                config.port = parseInt(port);
                config.uuid = auth;
                
                if (params) {
                  const urlParams = new URLSearchParams(params);
                  config.congestion = urlParams.get('congestion_control');
                }
              }
              
              // Validation
              if (!config.host || !config.port || isNaN(config.port)) {
                return null;
              }
              
              return config;
            } catch (e) {
              return null;
            }
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced Connection Test
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function testConnection(host, port, timeout = TIMEOUT, retries = 0) {
            return new Promise((resolve) => {
              const start = Date.now();
              const socket = net.createConnection({ 
                host, 
                port, 
                timeout,
                keepAlive: true 
              });
              
              let connected = false;
              let dataReceived = false;
              
              socket.on('connect', () => {
                connected = true;
                const latency = Date.now() - start;
                
                // Try to send/receive data to verify it's not a honeypot
                socket.write('HEAD / HTTP/1.1\r\nHost: ' + host + '\r\n\r\n');
                
                setTimeout(() => {
                  socket.destroy();
                  resolve({ 
                    success: true, 
                    latency, 
                    connected: true,
                    dataTransmitted: dataReceived 
                  });
                }, 100);
              });
              
              socket.on('data', () => {
                dataReceived = true;
              });
              
              socket.on('error', (err) => {
                socket.destroy();
                
                // Auto-retry logic
                if (ENABLE_AUTO_RETRY && retries < 2) {
                  setTimeout(() => {
                    testConnection(host, port, timeout, retries + 1).then(resolve);
                  }, 1000);
                  return;
                }
                
                resolve({ 
                  success: false, 
                  latency: Date.now() - start,
                  error: err.code || err.message,
                  connected: false,
                  dataTransmitted: false
                });
              });
              
              socket.on('timeout', () => {
                socket.destroy();
                resolve({ 
                  success: false, 
                  latency: timeout, 
                  error: 'TIMEOUT', 
                  connected: false,
                  dataTransmitted: false 
                });
              });
            });
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced DNS Resolution
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const dnsCache = new Map();
          const fallbackDNS = ['8.8.8.8', '1.1.1.1', '208.67.222.222'];
          
          async function resolveHost(host) {
            if (dnsCache.has(host)) return dnsCache.get(host);
            
            // Try primary DNS
            const primaryResult = await new Promise((resolve) => {
              dns.resolve4(host, (err, addresses) => {
                resolve(err ? null : addresses[0]);
              });
            });
            
            if (primaryResult) {
              dnsCache.set(host, primaryResult);
              return primaryResult;
            }
            
            // Try fallback DNS if enabled
            if (ENABLE_FALLBACK_DNS) {
              for (const dnsServer of fallbackDNS) {
                const resolver = new dns.Resolver();
                resolver.setServers([dnsServer]);
                
                const result = await new Promise((resolve) => {
                  resolver.resolve4(host, (err, addresses) => {
                    resolve(err ? null : addresses[0]);
                  });
                });
                
                if (result) {
                  dnsCache.set(host, result);
                  return result;
                }
              }
            }
            
            return null;
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced Stability Test
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          async function testStability(host, port) {
            const results = [];
            const latencies = [];
            
            for (let i = 0; i < STABILITY_ATTEMPTS; i++) {
              const result = await testConnection(host, port, TIMEOUT);
              results.push(result);
              
              if (result.success) {
                latencies.push(result.latency);
              }
              
              // Small delay between attempts
              await new Promise(r => setTimeout(r, 150));
            }
            
            const successful = results.filter(r => r.success).length;
            const avgLatency = latencies.length > 0 
              ? latencies.reduce((a, b) => a + b, 0) / latencies.length 
              : 0;
            
            // Calculate jitter (latency variance)
            let jitter = 0;
            if (latencies.length > 1) {
              const variance = latencies.reduce((sum, lat) => {
                return sum + Math.pow(lat - avgLatency, 2);
              }, 0) / latencies.length;
              jitter = Math.sqrt(variance);
            }
            
            const stabilityScore = (successful / STABILITY_ATTEMPTS) * 100;
            
            return {
              stable: stabilityScore >= 60,
              veryStable: stabilityScore >= 85,
              ultraStable: stabilityScore === 100 && jitter < 20,
              score: stabilityScore,
              successRate: successful / STABILITY_ATTEMPTS,
              avgLatency: Math.round(avgLatency),
              jitter: Math.round(jitter),
              attempts: STABILITY_ATTEMPTS,
              successful,
              results: results
            };
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced Score Calculator
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function calculateScore(config, testResults, stability, ip) {
            let score = 0;
            const breakdown = {};
            
            // Base protocol score
            const protocolConfig = PROTOCOL_WEIGHTS[config.protocol];
            if (protocolConfig) {
              let protocolScore = protocolConfig.base;
              
              // Protocol bonuses
              if (config.reality && protocolConfig.reality_bonus) {
                protocolScore += protocolConfig.reality_bonus;
                breakdown.reality = protocolConfig.reality_bonus;
              }
              if (config.tls && protocolConfig.tls_bonus) {
                protocolScore += protocolConfig.tls_bonus;
                breakdown.tls = protocolConfig.tls_bonus;
              }
              if (config.ws && protocolConfig.ws_bonus) {
                protocolScore += protocolConfig.ws_bonus;
                breakdown.ws = protocolConfig.ws_bonus;
              }
              if (config.grpc && protocolConfig.grpc_bonus) {
                protocolScore += protocolConfig.grpc_bonus;
                breakdown.grpc = protocolConfig.grpc_bonus;
              }
              if (config.h2 && protocolConfig.h2_bonus) {
                protocolScore += protocolConfig.h2_bonus;
                breakdown.h2 = protocolConfig.h2_bonus;
              }
              if (config.cdn && protocolConfig.cdn_bonus) {
                protocolScore += protocolConfig.cdn_bonus;
                breakdown.cdn_bonus = protocolConfig.cdn_bonus;
              }
              if (config.obfs && protocolConfig.obfs_bonus) {
                protocolScore += protocolConfig.obfs_bonus;
                breakdown.obfs = protocolConfig.obfs_bonus;
              }
              
              score += protocolScore;
              breakdown.protocol = protocolScore;
            }
            
            // Port scoring (Iran-optimized)
            const portScore = PORT_IRAN_SCORES[config.port] || PORT_IRAN_SCORES.default;
            score += portScore;
            breakdown.port = portScore;
            
            // CDN detection and scoring
            if (ip) {
              const cdn = detectCDN(ip);
              if (cdn) {
                const cdnScore = getCDNScore(cdn);
                score += cdnScore;
                breakdown.cdn_detected = cdnScore;
                config.cdn = cdn;
                
                if (cdn === 'cloudflare') {
                  score += 50; // Extra bonus for Cloudflare
                  breakdown.cloudflare_bonus = 50;
                }
              }
            }
            
            // Latency scoring (optimized)
            if (testResults.latency) {
              let latencyScore;
              if (testResults.latency < 30) latencyScore = 120;
              else if (testResults.latency < 50) latencyScore = 100;
              else if (testResults.latency < 100) latencyScore = 80;
              else if (testResults.latency < 150) latencyScore = 60;
              else if (testResults.latency < 250) latencyScore = 40;
              else if (testResults.latency < 350) latencyScore = 25;
              else latencyScore = 15;
              
              score += latencyScore;
              breakdown.latency = latencyScore;
            }
            
            // Stability scoring (critical)
            if (stability) {
              const stabilityScore = stability.score * 1.5;
              score += stabilityScore;
              breakdown.stability = Math.round(stabilityScore);
              
              if (stability.ultraStable) {
                score += 120;
                breakdown.ultra_stable = 120;
              } else if (stability.veryStable) {
                score += 80;
                breakdown.very_stable = 80;
              }
              
              // Jitter penalty
              if (stability.jitter > 100) {
                score -= 30;
                breakdown.jitter_penalty = -30;
              } else if (stability.jitter < 20) {
                score += 40;
                breakdown.low_jitter_bonus = 40;
              }
            }
            
            // DPI risk assessment
            if (ENABLE_DPI_EVASION && ENABLE_IRAN_OPT) {
              const dpiRisk = calculateIranDPIRisk(config, testResults);
              let dpiScore;
              if (dpiRisk.risk === 'low') dpiScore = 90;
              else if (dpiRisk.risk === 'medium') dpiScore = 40;
              else dpiScore = -60;
              
              score += dpiScore;
              breakdown.dpi_risk = dpiScore;
            }
            
            // ML confidence bonus
            if (ENABLE_ML) {
              const mlConfidence = calculateMLConfidence(config, testResults);
              const mlScore = (mlConfidence / 100) * 70;
              score += mlScore;
              breakdown.ml_confidence = Math.round(mlScore);
            }
            
            // Historical host performance
            const hostSuccesses = successfulHosts.get(config.host) || 0;
            if (hostSuccesses >= 10) {
              score += 60;
              breakdown.proven_host = 60;
            } else if (hostSuccesses >= 5) {
              score += 30;
              breakdown.known_host = 30;
            }
            
            return { 
              total: Math.round(score), 
              breakdown 
            };
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Grade Assignment
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function assignGrade(score) {
            if (score >= 950) return 'S+';
            if (score >= 900) return 'S';
            if (score >= 800) return 'A+';
            if (score >= 700) return 'A';
            if (score >= 600) return 'B+';
            if (score >= 500) return 'B';
            if (score >= 400) return 'C';
            return 'D';
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Main Test Function
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          async function testConfig(url) {
            const config = parseConfig(url);
            if (!config || !config.host || !config.port) {
              return null;
            }
            
            // Initial connection test
            const testResult = await testConnection(config.host, config.port, TIMEOUT);
            if (!testResult.success) {
              // Record failure for ML
              failedHosts.set(config.host, (failedHosts.get(config.host) || 0) + 1);
              return null;
            }
            
            // Resolve IP and detect CDN
            const ip = await resolveHost(config.host);
            if (ip) {
              config.cdn = detectCDN(ip);
              config.ip = ip;
            }
            
            // Stability test
            const stability = await testStability(config.host, config.port);
            if (!stability.stable) {
              failedHosts.set(config.host, (failedHosts.get(config.host) || 0) + 1);
              return null;
            }
            
            // Calculate score
            const scoreResult = calculateScore(config, testResult, stability, ip);
            const score = scoreResult.total;
            
            // Apply minimum score filter
            if (score < MIN_SCORE) {
              return null;
            }
            
            // Honeypot detection
            if (ENABLE_HONEYPOT) {
              const honeypot = detectHoneypot(config, testResult);
              if (honeypot.isHoneypot) {
                console.log(`ğŸ´â€â˜ ï¸ Honeypot detected: ${config.host}:${config.port} (confidence: ${honeypot.confidence}%)`);
                return null;
              }
              config.honeypot_check = honeypot;
            }
            
            // Record success for ML
            successfulHosts.set(config.host, (successfulHosts.get(config.host) || 0) + 1);
            
            // DPI risk
            const dpiRisk = ENABLE_IRAN_OPT ? 
              calculateIranDPIRisk(config, testResult) : 
              { risk: 'unknown', score: 0, reasons: [] };
            
            // ML confidence
            const mlConfidence = ENABLE_ML ? 
              calculateMLConfidence(config, testResult) : 50;
            
            return {
              config: url,
              protocol: config.protocol,
              host: config.host,
              port: config.port,
              ip: config.ip,
              latency: testResult.latency,
              stability: stability.score,
              veryStable: stability.veryStable,
              ultraStable: stability.ultraStable,
              jitter: stability.jitter,
              score: score,
              score_breakdown: scoreResult.breakdown,
              grade: assignGrade(score),
              cdn: config.cdn || null,
              reality: config.reality || false,
              tls: config.tls || false,
              ws: config.ws || false,
              grpc: config.grpc || false,
              h2: config.h2 || false,
              obfs: config.obfs || null,
              dpi_risk: dpiRisk.risk,
              dpi_score: dpiRisk.score,
              dpi_reasons: dpiRisk.reasons,
              ml_confidence: mlConfidence,
              iran_optimized: ENABLE_IRAN_OPT,
              tested_at: Date.now()
            };
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Main Execution
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          (async () => {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ§ª QuantumRoute V6 - Supreme Intelligence Tester (Enhanced)');
            console.log('ğŸ‡®ğŸ‡· Iran Optimization: ENABLED');
            console.log('ğŸ›¡ï¸  Advanced DPI Evasion: ENABLED');
            console.log('ğŸ§  Machine Learning: ENABLED');
            console.log('ğŸ”„ Auto-Retry: ENABLED');
            console.log('ğŸŒ Fallback DNS: ENABLED');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const configs = fs.readFileSync('tmp/unique.txt', 'utf8')
              .split('\n')
              .filter(line => line.trim().length > 0);
            
            console.log(`ğŸ“Š Total configs to test: ${configs.length}`);
            console.log(`âš™ï¸  Parallel workers: ${PARALLEL}`);
            console.log(`â±ï¸  Timeout: ${TIMEOUT}ms`);
            console.log(`ğŸ“ˆ Minimum score: ${MIN_SCORE}`);
            console.log(`ğŸ”„ Stability attempts: ${STABILITY_ATTEMPTS}`);
            console.log(`ğŸ§  ML history records: ${mlHistory.length}`);
            
            const results = [];
            let tested = 0;
            let working = 0;
            let honepotsDetected = 0;
            const startTime = Date.now();
            
            const tasks = configs.map(config => limit(async () => {
              const result = await testConfig(config);
              tested++;
              
              if (result) {
                working++;
                results.push(result);
                
                if (working % 5 === 0) {
                  const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                  const rate = (tested / (elapsed / 60)).toFixed(1);
                  console.log(`âœ… Working: ${working} | Tested: ${tested}/${configs.length} | Rate: ${rate}/min`);
                }
              }
              
              if (tested % 50 === 0) {
                const progress = Math.round(tested / configs.length * 100);
                console.log(`ğŸ“Š Progress: ${progress}% | Working: ${working}`);
              }
            }));
            
            await Promise.all(tasks);
            
            const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
            
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
            console.log(`âœ… Testing complete in ${totalTime}s!`);
            console.log(`ğŸ“Š Total tested: ${tested}`);
            console.log(`âœ… Working configs: ${working}`);
            console.log(`ğŸ“ˆ Success rate: ${(working / tested * 100).toFixed(2)}%`);
            console.log(`âš¡ Testing rate: ${(tested / (totalTime / 60)).toFixed(1)} configs/min`);
            
            // Sort by score
            results.sort((a, b) => b.score - a.score);
            
            // Calculate statistics
            const grades = { 'S+': 0, S: 0, 'A+': 0, A: 0, 'B+': 0, B: 0, C: 0, D: 0 };
            results.forEach(r => grades[r.grade]++);
            
            const avgLatency = Math.round(
              results.reduce((sum, r) => sum + r.latency, 0) / results.length
            );
            
            const avgScore = Math.round(
              results.reduce((sum, r) => sum + r.score, 0) / results.length
            );
            
            const avgConfidence = Math.round(
              results.reduce((sum, r) => sum + r.ml_confidence, 0) / results.length
            );
            
            const avgJitter = Math.round(
              results.reduce((sum, r) => sum + (r.jitter || 0), 0) / results.length
            );
            
            const highDPIRisk = results.filter(r => r.dpi_risk === 'high').length;
            const mediumDPIRisk = results.filter(r => r.dpi_risk === 'medium').length;
            const lowDPIRisk = results.filter(r => r.dpi_risk === 'low').length;
            const cloudflareCount = results.filter(r => r.cdn === 'cloudflare').length;
            const realityCount = results.filter(r => r.reality).length;
            const veryStableCount = results.filter(r => r.veryStable).length;
            const ultraStableCount = results.filter(r => r.ultraStable).length;
            
            // Protocol distribution
            const protocols = {};
            results.forEach(r => {
              protocols[r.protocol] = (protocols[r.protocol] || 0) + 1;
            });
            
            // Save results
            const output = {
              timestamp: new Date().toISOString(),
              version: '6.0-enhanced',
              iran_optimized: ENABLE_IRAN_OPT,
              dpi_evasion: ENABLE_DPI_EVASION,
              ml_enabled: ENABLE_ML,
              testing_params: {
                timeout: TIMEOUT,
                parallel: PARALLEL,
                min_score: MIN_SCORE,
                stability_attempts: STABILITY_ATTEMPTS
              },
              summary: {
                total_tested: tested,
                working: working,
                success_rate: ((working / tested) * 100).toFixed(2) + '%',
                testing_time: totalTime + 's',
                testing_rate: (tested / (totalTime / 60)).toFixed(1) + ' configs/min'
              },
              grades: grades,
              quality: {
                avg_latency: avgLatency,
                avg_jitter: avgJitter,
                avg_score: avgScore,
                avg_confidence: avgConfidence
              },
              security: {
                honeypots_detected: honepotsDetected,
                dpi_risk_high: highDPIRisk,
                dpi_risk_medium: mediumDPIRisk,
                dpi_risk_low: lowDPIRisk,
                cloudflare: cloudflareCount,
                reality: realityCount
              },
              stability: {
                ultra_stable: ultraStableCount,
                very_stable: veryStableCount,
                stable_rate: ((veryStableCount / working) * 100).toFixed(2) + '%'
              },
              protocols: protocols,
              top_50: results.slice(0, 50),
              all_results: results
            };
            
            fs.writeFileSync('output/results.json', JSON.stringify(output, null, 2));
            
            // Export configs - Multiple formats
            fs.writeFileSync('output/configs.txt', 
              results.map(r => r.config).join('\n')
            );
            
            fs.writeFileSync('output/configs_base64.txt', 
              Buffer.from(results.map(r => r.config).join('\n')).toString('base64')
            );
            
            // Best configs by count
            fs.writeFileSync('output/best_200.txt', 
              results.slice(0, 200).map(r => r.config).join('\n')
            );
            
            fs.writeFileSync('output/best_100.txt', 
              results.slice(0, 100).map(r => r.config).join('\n')
            );
            
            fs.writeFileSync('output/best_50.txt', 
              results.slice(0, 50).map(r => r.config).join('\n')
            );
            
            // Premium grades
            fs.writeFileSync('output/premium.txt', 
              results.filter(r => ['S+', 'S', 'A+', 'A'].includes(r.grade))
                .map(r => r.config).join('\n')
            );
            
            // Grade S+ and S only
            fs.writeFileSync('output/grade_s_plus.txt', 
              results.filter(r => r.grade === 'S+').map(r => r.config).join('\n')
            );
            
            fs.writeFileSync('output/grade_s.txt', 
              results.filter(r => r.grade === 'S').map(r => r.config).join('\n')
            );
            
            // Iran-optimized (low DPI risk + high score)
            fs.writeFileSync('output/iran_safe.txt', 
              results.filter(r => r.dpi_risk === 'low' && r.score >= 600)
                .map(r => r.config).join('\n')
            );
            
            // Ultra stable configs
            fs.writeFileSync('output/ultra_stable.txt', 
              results.filter(r => r.ultraStable).map(r => r.config).join('\n')
            );
            
            // Cloudflare only
            fs.writeFileSync('output/cloudflare.txt', 
              results.filter(r => r.cdn === 'cloudflare').map(r => r.config).join('\n')
            );
            
            // Reality protocol only
            fs.writeFileSync('output/reality.txt', 
              results.filter(r => r.reality).map(r => r.config).join('\n')
            );
            
            // By protocol
            Object.keys(protocols).forEach(protocol => {
              fs.writeFileSync(`output/protocol_${protocol}.txt`, 
                results.filter(r => r.protocol === protocol).map(r => r.config).join('\n')
              );
            });
            
            // Stats for commit message
            fs.writeFileSync('output/stats.json', JSON.stringify({
              working: working,
              grade_s_plus: grades['S+'],
              grade_s: grades.S,
              grade_a_plus: grades['A+'],
              grade_a: grades.A,
              avg_score: avgScore,
              iran_safe: lowDPIRisk,
              ultra_stable: ultraStableCount,
              cloudflare: cloudflareCount,
              reality: realityCount
            }));
            
            // Update ML history
            const newHistory = results.map(r => ({
              protocol: r.protocol,
              host: r.host,
              port: r.port,
              cdn: r.cdn,
              latency: r.latency,
              jitter: r.jitter,
              success: true,
              score: r.score,
              timestamp: Date.now()
            }));
            
            const updatedHistory = [...mlHistory, ...newHistory].slice(-2000); // Keep last 2000
            fs.writeFileSync('output/history.json', JSON.stringify(updatedHistory));
            
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
            console.log(`ğŸ“Š Grade Distribution:`);
            console.log(`   ğŸ† S+: ${grades['S+']}`);
            console.log(`   ğŸ† S:  ${grades.S}`);
            console.log(`   â­ A+: ${grades['A+']}`);
            console.log(`   â­ A:  ${grades.A}`);
            console.log(`   ğŸ“˜ B+: ${grades['B+']}`);
            console.log(`   ğŸ“˜ B:  ${grades.B}`);
            console.log(`   ğŸ“™ C:  ${grades.C}`);
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
            console.log(`ğŸ›¡ï¸  Security Analysis:`);
            console.log(`   âœ… Low DPI Risk: ${lowDPIRisk}`);
            console.log(`   âš ï¸  Medium DPI Risk: ${mediumDPIRisk}`);
            console.log(`   âŒ High DPI Risk: ${highDPIRisk}`);
            console.log(`   â˜ï¸  Cloudflare: ${cloudflareCount}`);
            console.log(`   ğŸ” Reality: ${realityCount}`);
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
            console.log(`ğŸ“¡ Stability Analysis:`);
            console.log(`   ğŸŒŸ Ultra Stable: ${ultraStableCount}`);
            console.log(`   âœ… Very Stable: ${veryStableCount}`);
            console.log(`   ğŸ“Š Avg Jitter: ${avgJitter}ms`);
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
            
            process.exit(0);
          })();
          TESTER_V6_ENHANCED_EOF
          
          node tester.js

      - name: ğŸ“Š Generate Enhanced Dashboard
        run: |
          cat << 'DASHBOARD_ENHANCED_EOF' > output/index.html
          <!DOCTYPE html>
          <html lang="fa" dir="rtl">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>QuantumRoute V6 Enhanced - Supreme Intelligence ğŸ‡®ğŸ‡·</title>
            <style>
              :root {
                --bg-primary: #0a0e27;
                --bg-secondary: #141b3d;
                --bg-card: #1a2142;
                --accent-gold: #ffd700;
                --accent-green: #00ff88;
                --accent-blue: #00d4ff;
                --accent-cyan: #00ffff;
                --accent-red: #ff4444;
                --accent-orange: #ff9500;
                --text-primary: #ffffff;
                --text-secondary: #b8c5d6;
                --iran-green: #00a651;
                --iran-red: #c8102e;
                --iran-white: #ffffff;
              }
              
              * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
              }
              
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
                color: var(--text-primary);
                min-height: 100vh;
                padding: 20px;
                overflow-x: hidden;
              }
              
              .container {
                max-width: 1600px;
                margin: 0 auto;
              }
              
              header {
                text-align: center;
                padding: 50px 20px;
                background: linear-gradient(135deg, var(--iran-green) 0%, var(--bg-card) 50%, var(--iran-red) 100%);
                border-radius: 25px;
                margin-bottom: 40px;
                box-shadow: 0 15px 50px rgba(0, 255, 136, 0.4);
                position: relative;
                overflow: hidden;
              }
              
              header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
                animation: shine 3s infinite;
              }
              
              @keyframes shine {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
              }
              
              h1 {
                font-size: 3.5em;
                background: linear-gradient(135deg, var(--accent-gold), var(--accent-cyan), var(--accent-gold));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 15px;
                position: relative;
                z-index: 1;
              }
              
              .subtitle {
                color: var(--text-secondary);
                font-size: 1.3em;
                margin: 10px 0;
                position: relative;
                z-index: 1;
              }
              
              .version-badge {
                display: inline-block;
                background: linear-gradient(135deg, #ffd700, #ffed4e);
                color: #000;
                padding: 8px 20px;
                border-radius: 20px;
                font-weight: bold;
                margin-top: 10px;
                font-size: 0.9em;
              }
              
              .iran-flag {
                font-size: 4em;
                margin: 15px 0;
                position: relative;
                z-index: 1;
              }
              
              .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 25px;
                margin-bottom: 40px;
              }
              
              .stat-card {
                background: var(--bg-card);
                padding: 30px;
                border-radius: 20px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
                border: 2px solid transparent;
                transition: all 0.4s ease;
                position: relative;
                overflow: hidden;
              }
              
              .stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, transparent, rgba(0, 255, 136, 0.1));
                opacity: 0;
                transition: opacity 0.4s;
              }
              
              .stat-card:hover {
                transform: translateY(-8px) scale(1.02);
                box-shadow: 0 15px 40px rgba(0, 255, 136, 0.5);
                border-color: var(--accent-green);
              }
              
              .stat-card:hover::before {
                opacity: 1;
              }
              
              .stat-icon {
                font-size: 3em;
                margin-bottom: 15px;
              }
              
              .stat-value {
                font-size: 3em;
                font-weight: bold;
                margin: 15px 0;
                text-shadow: 0 0 20px currentColor;
              }
              
              .stat-label {
                color: var(--text-secondary);
                font-size: 1.2em;
                font-weight: 500;
              }
              
              .section {
                background: var(--bg-card);
                padding: 40px;
                border-radius: 20px;
                margin-bottom: 40px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
              }
              
              .section-title {
                font-size: 2.5em;
                margin: 0 0 30px 0;
                background: linear-gradient(135deg, var(--accent-gold), var(--accent-cyan));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                display: flex;
                align-items: center;
                gap: 15px;
              }
              
              .grades-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 25px;
                margin-top: 30px;
              }
              
              .grade-card {
                text-align: center;
                padding: 30px;
                border-radius: 15px;
                background: rgba(255, 255, 255, 0.05);
                transition: all 0.3s ease;
                border: 2px solid transparent;
              }
              
              .grade-card:hover {
                transform: scale(1.05);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                border-color: currentColor;
              }
              
              .grade-badge {
                font-size: 3.5em;
                font-weight: bold;
                display: inline-block;
                padding: 15px 30px;
                border-radius: 15px;
                margin-bottom: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
              }
              
              .grade-s-plus { background: linear-gradient(135deg, #ff6b6b, #ffd700); color: #000; }
              .grade-s { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; }
              .grade-a-plus { background: linear-gradient(135deg, #00ff88, #00d4ff); color: #000; }
              .grade-a { background: linear-gradient(135deg, #00d4ff, #00ffaa); color: #000; }
              .grade-b-plus { background: linear-gradient(135deg, #00d4ff, #0099ff); color: #000; }
              .grade-b { background: linear-gradient(135deg, #0099ff, #0066ff); color: #fff; }
              .grade-c { background: linear-gradient(135deg, #ff9500, #ffb84d); color: #000; }
              
              .actions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin: 40px 0;
              }
              
              .btn {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                padding: 20px 30px;
                text-align: center;
                text-decoration: none;
                border-radius: 15px;
                font-weight: bold;
                font-size: 1.1em;
                transition: all 0.3s ease;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
                position: relative;
                overflow: hidden;
              }
              
              .btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
              }
              
              .btn:hover::before {
                width: 300px;
                height: 300px;
              }
              
              .btn-gold {
                background: linear-gradient(135deg, #ffd700, #ffed4e);
                color: #000;
              }
              
              .btn-primary {
                background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
                color: #000;
              }
              
              .btn-secondary {
                background: linear-gradient(135deg, var(--accent-blue), #0099ff);
                color: #fff;
              }
              
              .btn-iran {
                background: linear-gradient(135deg, var(--iran-green), var(--iran-red));
                color: #fff;
              }
              
              .btn:hover {
                transform: translateY(-5px) scale(1.05);
                box-shadow: 0 12px 35px rgba(0, 255, 136, 0.6);
              }
              
              .table-container {
                background: var(--bg-card);
                padding: 30px;
                border-radius: 20px;
                overflow-x: auto;
                margin-top: 30px;
              }
              
              table {
                width: 100%;
                border-collapse: collapse;
              }
              
              th, td {
                padding: 18px;
                text-align: right;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
              }
              
              th {
                background: rgba(0, 255, 136, 0.2);
                color: var(--accent-green);
                font-weight: bold;
                font-size: 1.1em;
              }
              
              tr {
                transition: background 0.3s ease;
              }
              
              tr:hover {
                background: rgba(255, 255, 255, 0.08);
              }
              
              .protocol-tag {
                display: inline-block;
                padding: 6px 14px;
                border-radius: 8px;
                font-size: 0.95em;
                font-weight: bold;
              }
              
              .protocol-vless { background: #00ff88; color: #000; }
              .protocol-vmess { background: #00d4ff; color: #000; }
              .protocol-trojan { background: #ff9500; color: #000; }
              .protocol-hysteria2 { background: #ffd700; color: #000; }
              .protocol-hysteria { background: #ffb84d; color: #000; }
              .protocol-tuic { background: #ff6b9d; color: #000; }
              .protocol-ss { background: #9d50ff; color: #fff; }
              
              .risk-badge {
                padding: 6px 12px;
                border-radius: 8px;
                font-size: 0.9em;
                font-weight: bold;
              }
              
              .risk-low { background: var(--accent-green); color: #000; }
              .risk-medium { background: var(--accent-orange); color: #000; }
              .risk-high { background: var(--accent-red); color: #fff; }
              
              .confidence-bar {
                display: inline-flex;
                align-items: center;
                gap: 10px;
              }
              
              .confidence-bar-visual {
                width: 80px;
                height: 10px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 5px;
                overflow: hidden;
              }
              
              .confidence-fill {
                height: 100%;
                border-radius: 5px;
                transition: width 0.5s ease, background 0.5s ease;
              }
              
              .badge {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 6px;
                font-size: 0.85em;
                font-weight: bold;
                margin: 0 3px;
              }
              
              .badge-success { background: var(--accent-green); color: #000; }
              .badge-warning { background: var(--accent-orange); color: #000; }
              .badge-info { background: var(--accent-blue); color: #fff; }
              
              footer {
                text-align: center;
                margin-top: 60px;
                padding: 30px;
                color: var(--text-secondary);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
              }
              
              footer p {
                margin: 10px 0;
                font-size: 1.1em;
              }
              
              .alert-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 25px;
                margin-top: 30px;
              }
              
              .alert-card {
                background: rgba(255, 255, 255, 0.05);
                padding: 30px;
                border-radius: 15px;
                text-align: center;
                border: 2px solid transparent;
                transition: all 0.3s ease;
              }
              
              .alert-card:hover {
                border-color: var(--accent-cyan);
                transform: scale(1.08);
                box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
              }
              
              .alert-icon {
                font-size: 2.5em;
                margin-bottom: 15px;
              }
              
              .alert-value {
                font-size: 2.5em;
                font-weight: bold;
                margin: 15px 0;
              }
              
              .chart-placeholder {
                height: 200px;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                margin-top: 20px;
              }
              
              @media (max-width: 768px) {
                h1 { font-size: 2.5em; }
                .stats-grid { grid-template-columns: 1fr; }
                .grades-grid { grid-template-columns: repeat(2, 1fr); }
                .actions { grid-template-columns: 1fr; }
              }
              
              .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: var(--accent-green);
                animation: spin 1s ease-in-out infinite;
              }
              
              @keyframes spin {
                to { transform: rotate(360deg); }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <div class="iran-flag">ğŸ‡®ğŸ‡·</div>
                <h1>QuantumRoute V6 Enhanced</h1>
                <div class="version-badge">Version 6.0 - Supreme Intelligence</div>
                <p class="subtitle">ğŸ›¡ï¸ Advanced DPI Evasion | ğŸ§  Machine Learning | ğŸ”’ Maximum Security</p>
                <p class="subtitle">âš¡ Auto-Retry | ğŸŒ Fallback DNS | ğŸ“Š Real-time Analytics</p>
              </header>
              
              <div id="stats" class="stats-grid"></div>
              
              <div class="section">
                <h2 class="section-title"><span>ğŸ“Š</span> Grade Distribution</h2>
                <div class="grades-grid">
                  <div class="grade-card">
                    <div class="grade-badge grade-s-plus">S+</div>
                    <div id="grade-s-plus" class="stat-value">-</div>
                    <div class="stat-label">Supreme Elite (950+)</div>
                  </div>
                  <div class="grade-card">
                    <div class="grade-badge grade-s">S</div>
                    <div id="grade-s" class="stat-value">-</div>
                    <div class="stat-label">Supreme (900-949)</div>
                  </div>
                  <div class="grade-card">
                    <div class="grade-badge grade-a-plus">A+</div>
                    <div id="grade-a-plus" class="stat-value">-</div>
                    <div class="stat-label">Excellent Plus (800-899)</div>
                  </div>
                  <div class="grade-card">
                    <div class="grade-badge grade-a">A</div>
                    <div id="grade-a" class="stat-value">-</div>
                    <div class="stat-label">Excellent (700-799)</div>
                  </div>
                  <div class="grade-card">
                    <div class="grade-badge grade-b-plus">B+</div>
                    <div id="grade-b-plus" class="stat-value">-</div>
                    <div class="stat-label">Good Plus (600-699)</div>
                  </div>
                  <div class="grade-card">
                    <div class="grade-badge grade-b">B</div>
                    <div id="grade-b" class="stat-value">-</div>
                    <div class="stat-label">Good (500-599)</div>
                  </div>
                  <div class="grade-card">
                    <div class="grade-badge grade-c">C</div>
                    <div id="grade-c" class="stat-value">-</div>
                    <div class="stat-label">Acceptable (400-499)</div>
                  </div>
                </div>
              </div>
              
              <div class="section">
                <h2 class="section-title"><span>ğŸ›¡ï¸</span> Security & Stability Analysis</h2>
                <div id="security" class="alert-grid"></div>
              </div>
              
              <div class="section">
                <h2 class="section-title"><span>ğŸ“¡</span> Protocol Distribution</h2>
                <div id="protocols" class="alert-grid"></div>
              </div>
              
              <div class="actions">
                <a href="grade_s_plus.txt" class="btn btn-gold">
                  <span>ğŸ†</span>
                  <span>Grade S+ Elite</span>
                </a>
                <a href="grade_s.txt" class="btn btn-gold">
                  <span>ğŸ†</span>
                  <span>Grade S Supreme</span>
                </a>
                <a href="premium.txt" class="btn btn-primary">
                  <span>â­</span>
                  <span>Premium (S+,S,A+,A)</span>
                </a>
                <a href="iran_safe.txt" class="btn btn-iran">
                  <span>ğŸ‡®ğŸ‡·</span>
                  <span>Iran Safe</span>
                </a>
                <a href="ultra_stable.txt" class="btn btn-primary">
                  <span>ğŸŒŸ</span>
                  <span>Ultra Stable</span>
                </a>
                <a href="cloudflare.txt" class="btn btn-secondary">
                  <span>â˜ï¸</span>
                  <span>Cloudflare Only</span>
                </a>
                <a href="reality.txt" class="btn btn-secondary">
                  <span>ğŸ”</span>
                  <span>Reality Protocol</span>
                </a>
                <a href="best_200.txt" class="btn btn-secondary">
                  <span>ğŸ“¥</span>
                  <span>Top 200</span>
                </a>
                <a href="best_100.txt" class="btn btn-secondary">
                  <span>ğŸ“¥</span>
                  <span>Top 100</span>
                </a>
                <a href="best_50.txt" class="btn btn-secondary">
                  <span>ğŸ“¥</span>
                  <span>Top 50</span>
                </a>
                <a href="configs.txt" class="btn btn-secondary">
                  <span>ğŸ“„</span>
                  <span>All Working</span>
                </a>
                <a href="configs_base64.txt" class="btn btn-secondary">
                  <span>ğŸ”</span>
                  <span>Base64</span>
                </a>
                <a href="results.json" class="btn btn-secondary">
                  <span>ğŸ“Š</span>
                  <span>Full JSON</span>
                </a>
              </div>
              
              <h2 class="section-title"><span>ğŸ†</span> Top 50 Supreme Configs</h2>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Grade</th>
                      <th>Protocol</th>
                      <th>Host</th>
                      <th>Port</th>
                      <th>Latency</th>
                      <th>Jitter</th>
                      <th>Score</th>
                      <th>ML Confidence</th>
                      <th>DPI Risk</th>
                      <th>CDN</th>
                      <th>Features</th>
                    </tr>
                  </thead>
                  <tbody id="results"></tbody>
                </table>
              </div>
            </div>
            
            <footer>
              <p><strong>ğŸ‡®ğŸ‡· Optimized for Iran's Network Environment</strong></p>
              <p>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="timestamp">-</span></p>
              <p><strong>QuantumRoute V6 Enhanced - Supreme Intelligence Engine</strong></p>
              <p>ğŸ›¡ï¸ Advanced DPI Evasion | ğŸ§  Machine Learning | ğŸ”’ Honeypot Detection | âš¡ Auto-Retry</p>
              <p style="margin-top: 20px; color: var(--accent-green);">
                <strong>Testing Rate:</strong> <span id="testing-rate">-</span> configs/min | 
                <strong>Testing Time:</strong> <span id="testing-time">-</span>
              </p>
            </footer>
            
            <script>
              async function load() {
                try {
                  const data = await fetch('results.json').then(r => r.json());
                  
                  // Stats
                  const statsHtml = `
                    <div class="stat-card">
                      <div class="stat-icon">ğŸ“„</div>
                      <div class="stat-value" style="color: var(--accent-blue)">${data.summary.total_tested}</div>
                      <div class="stat-label">Ú©Ù„ ØªØ³Øª Ø´Ø¯Ù‡</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">âœ…</div>
                      <div class="stat-value" style="color: var(--accent-green)">${data.summary.working}</div>
                      <div class="stat-label">Ø³Ø§Ù„Ù…</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">ğŸ“ˆ</div>
                      <div class="stat-value" style="color: var(--accent-cyan)">${data.summary.success_rate}</div>
                      <div class="stat-label">Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">âš¡</div>
                      <div class="stat-value" style="color: var(--accent-orange)">${data.quality.avg_latency}ms</div>
                      <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ØªØ§Ø®ÛŒØ±</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">ğŸ“Š</div>
                      <div class="stat-value" style="color: var(--accent-orange)">${data.quality.avg_jitter}ms</div>
                      <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¬ÛŒØªØ±</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">ğŸ†</div>
                      <div class="stat-value" style="color: var(--accent-gold)">${data.quality.avg_score}</div>
                      <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">ğŸ§ </div>
                      <div class="stat-value" style="color: var(--accent-cyan)">${data.quality.avg_confidence}%</div>
                      <div class="stat-label">Ø§Ø·Ù…ÛŒÙ†Ø§Ù† ML</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">â˜ï¸</div>
                      <div class="stat-value" style="color: var(--accent-blue)">${data.security.cloudflare}</div>
                      <div class="stat-label">Cloudflare CDN</div>
                    </div>
                  `;
                  document.getElementById('stats').innerHTML = statsHtml;
                  
                  // Grades
                  document.getElementById('grade-s-plus').textContent = data.grades['S+'] || 0;
                  document.getElementById('grade-s').textContent = data.grades.S || 0;
                  document.getElementById('grade-a-plus').textContent = data.grades['A+'] || 0;
                  document.getElementById('grade-a').textContent = data.grades.A || 0;
                  document.getElementById('grade-b-plus').textContent = data.grades['B+'] || 0;
                  document.getElementById('grade-b').textContent = data.grades.B || 0;
                  document.getElementById('grade-c').textContent = data.grades.C || 0;
                  
                  // Security
                  const securityHtml = `
                    <div class="alert-card">
                      <div class="alert-icon">ğŸ´â€â˜ ï¸</div>
                      <div class="alert-value" style="color: var(--accent-red)">${data.security.honeypots_detected}</div>
                      <div class="stat-label">Honeypots Detected</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">âŒ</div>
                      <div class="alert-value" style="color: var(--accent-red)">${data.security.dpi_risk_high}</div>
                      <div class="stat-label">High DPI Risk</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">âš ï¸</div>
                      <div class="alert-value" style="color: var(--accent-orange)">${data.security.dpi_risk_medium}</div>
                      <div class="stat-label">Medium DPI Risk</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">âœ…</div>
                      <div class="alert-value" style="color: var(--accent-green)">${data.security.dpi_risk_low}</div>
                      <div class="stat-label">Low DPI Risk</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">ğŸ”</div>
                      <div class="alert-value" style="color: var(--accent-green)">${data.security.reality}</div>
                      <div class="stat-label">Reality Protected</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">ğŸŒŸ</div>
                      <div class="alert-value" style="color: var(--accent-gold)">${data.stability.ultra_stable}</div>
                      <div class="stat-label">Ultra Stable</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">âœ…</div>
                      <div class="alert-value" style="color: var(--accent-blue)">${data.stability.very_stable}</div>
                      <div class="stat-label">Very Stable</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">ğŸ“Š</div>
                      <div class="alert-value" style="color: var(--accent-cyan)">${data.stability.stable_rate}</div>
                      <div class="stat-label">Stability Rate</div>
                    </div>
                  `;
                  document.getElementById('security').innerHTML = securityHtml;
                  
                  // Protocols
                  let protocolsHtml = '';
                  for (const [protocol, count] of Object.entries(data.protocols || {})) {
                    protocolsHtml += `
                      <div class="alert-card">
                        <div class="alert-icon">ğŸ”—</div>
                        <div class="alert-value" style="color: var(--accent-cyan)">${count}</div>
                        <div class="stat-label">${protocol.toUpperCase()}</div>
                      </div>
                    `;
                  }
                  document.getElementById('protocols').innerHTML = protocolsHtml;
                  
                  // Table
                  const tbody = document.getElementById('results');
                  (data.top_50 || data.top_30 || []).forEach((r, i) => {
                    const gradeClass = r.grade.toLowerCase().replace('+', '-plus');
                    const riskClass = r.dpi_risk === 'high' ? 'high' : r.dpi_risk === 'medium' ? 'medium' : 'low';
                    const confColor = r.ml_confidence >= 70 ? 'var(--accent-green)' : 
                                     r.ml_confidence >= 50 ? 'var(--accent-orange)' : 'var(--accent-red)';
                    
                    const features = [];
                    if (r.reality) features.push('<span class="badge badge-success">Reality</span>');
                    if (r.tls) features.push('<span class="badge badge-info">TLS</span>');
                    if (r.ws) features.push('<span class="badge badge-info">WS</span>');
                    if (r.grpc) features.push('<span class="badge badge-info">gRPC</span>');
                    if (r.h2) features.push('<span class="badge badge-info">HTTP/2</span>');
                    if (r.ultraStable) features.push('<span class="badge badge-success">Ultra</span>');
                    if (r.veryStable) features.push('<span class="badge badge-success">Stable</span>');
                    
                    tbody.innerHTML += `
                      <tr>
                        <td><strong>${i + 1}</strong></td>
                        <td><span class="grade-badge ${gradeClass}" style="font-size: 1.2em; padding: 5px 12px;">${r.grade}</span></td>
                        <td><span class="protocol-tag protocol-${r.protocol}">${r.protocol}</span></td>
                        <td style="font-family: monospace; font-size: 0.9em;">${r.host}</td>
                        <td><strong>${r.port}</strong></td>
                        <td>${r.latency}ms</td>
                        <td>${r.jitter || 0}ms</td>
                        <td><strong style="color: var(--accent-gold); font-size: 1.2em;">${r.score}</strong></td>
                        <td>
                          <div class="confidence-bar">
                            <div class="confidence-bar-visual">
                              <div class="confidence-fill" style="width: ${r.ml_confidence}%; background: ${confColor}"></div>
                            </div>
                            <span>${r.ml_confidence}%</span>
                          </div>
                        </td>
                        <td><span class="risk-badge risk-${riskClass}">${r.dpi_risk || 'low'}</span></td>
                        <td>${r.cdn ? '<span class="badge badge-info">' + r.cdn + '</span>' : '-'}</td>
                        <td>${features.join(' ') || '-'}</td>
                      </tr>
                    `;
                  });
                  
                  // Footer stats
                  document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleString('fa-IR');
                  document.getElementById('testing-rate').textContent = data.summary.testing_rate || '-';
                  document.getElementById('testing-time').textContent = data.summary.testing_time || '-';
                  
                } catch (err) {
                  console.error('Error loading data:', err);
                  document.body.innerHTML = `
                    <div style="text-align:center;padding:50px;">
                      <h1 style="color: var(--accent-red);">âš ï¸ Error loading results</h1>
                      <p style="color: var(--text-secondary);">${err.message}</p>
                    </div>
                  `;
                }
              }
              load();
            </script>
          </body>
          </html>
          DASHBOARD_ENHANCED_EOF
          
          echo "âœ… Enhanced dashboard generated successfully"

      - name: ğŸ’¾ Commit & Push (FIXED)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          # Verify we have changes
          if [[ ! -f output/results.json ]]; then
            echo "âŒ ERROR: results.json not found"
            exit 1
          fi
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add output files
          git add output/
          
          # Create commit message
          if [[ -f output/stats.json ]]; then
            W=$(jq -r '.working' output/stats.json)
            SP=$(jq -r '.grade_s_plus' output/stats.json)
            S=$(jq -r '.grade_s' output/stats.json)
            AP=$(jq -r '.grade_a_plus' output/stats.json)
            A=$(jq -r '.grade_a' output/stats.json)
            SCORE=$(jq -r '.avg_score' output/stats.json)
            IRAN=$(jq -r '.iran_safe' output/stats.json)
            ULTRA=$(jq -r '.ultra_stable' output/stats.json)
            CF=$(jq -r '.cloudflare' output/stats.json)
            
            git commit -m "ğŸš€ V6 Enhanced ğŸ‡®ğŸ‡·: ${W} working | S+:${SP} S:${S} A+:${AP} A:${A} | Avg:${SCORE} | Iran-Safe:${IRAN} | Ultra:${ULTRA} | CF:${CF}"
          else
            git commit -m "ğŸš€ V6 Enhanced ğŸ‡®ğŸ‡· Update - Supreme Intelligence"
          fi
          
          # Force push to ensure changes are saved
          git push --force-with-lease origin main
          
          echo "âœ… Changes committed and pushed successfully"

      - name: ğŸ“¦ Upload Artifacts (Enhanced)
        uses: actions/upload-artifact@v4
        with:
          name: quantum-v6-enhanced-output-${{ github.run_number }}
          path: output/
          retention-days: 30
        continue-on-error: false

      - name: ğŸ“Š Generate Summary
        if: always()
        run: |
          echo "## ğŸš€ QuantumRoute V6 Enhanced Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f output/stats.json ]]; then
            echo "### ğŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- **Working Configs:** $(jq -r '.working' output/stats.json)" >> $GITHUB_STEP_SUMMARY
            echo "- **Grade S+:** $(jq -r '.grade_s_plus' output/stats.json)" >> $GITHUB_STEP_SUMMARY
            echo "- **Grade S:** $(jq -r '.grade_s' output/stats.json)" >> $GITHUB_STEP_SUMMARY
            echo "- **Average Score:** $(jq -r '.avg_score' output/stats.json)" >> $GITHUB_STEP_SUMMARY
            echo "- **Iran Safe:** $(jq -r '.iran_safe' output/stats.json)" >> $GITHUB_STEP_SUMMARY
            echo "- **Ultra Stable:** $(jq -r '.ultra_stable' output/stats.json)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ‰ Success!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No statistics available" >> $GITHUB_STEP_SUMMARY
          fi
