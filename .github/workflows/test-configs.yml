name: QuantumRoute V6 - Supreme Intelligence (Iran Optimized)

on:
  schedule:
    - cron: '0 */3 * * *'
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: quantum-v6
  cancel-in-progress: true

env:
  OUTPUT_DIR: output
  TIMEOUT_MS: 8000
  MAX_PARALLEL: 40
  MIN_SCORE: 450
  STABILITY_ATTEMPTS: 7
  ENABLE_ML: true
  ENABLE_HONEYPOT_DETECTION: true
  ENABLE_IRAN_OPTIMIZATION: true
  ENABLE_ADVANCED_DPI_EVASION: true

jobs:
  quantum-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install All Dependencies
        run: |
          set +e  # Don't exit on error
          sudo apt-get update -qq
          sudo apt-get install -y jq curl netcat-openbsd openssl dnsutils whois traceroute mtr-tiny
          npm init -y
          npm install p-limit node-fetch@2 geoip-lite
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ“ Create Directory Structure
        run: |
          set +e
          mkdir -p "$OUTPUT_DIR" tmp logs cache history iran_specific
          
          # Load previous results for ML
          if [[ -f output/history.json ]]; then
            cp output/history.json cache/history.json || true
          fi
          
          echo "âœ… Directories created"

      - name: ğŸŒ Fetch Configs from All Sources (Fixed)
        run: |
          set +e  # Don't exit on errors
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ QuantumRoute V6 - Supreme Intelligence Fetcher"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          SOURCES=(
            "https://ghproxy.net/https://raw.githubusercontent.com/barry-far/V2ray-Configs/refs/heads/main/All_Configs_Sub.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/85la/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/cfmeme/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/datiya/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/jichangx/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/nodefree/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/oneclash/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/cook369/proxy-collect/main/dist/yudou/v2ray.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/roosterkid/openproxylist/refs/heads/main/V2RAY_RAW.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/roosterkid/openproxylist/refs/heads/main/V2RAY_BASE64.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/all_extracted_configs.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/miladtahanian/V2RayCFGDumper/refs/heads/main/config.txt"
            "https://openproxylist.com/v2ray/rawlist/text"
            "https://openproxylist.com/v2ray/rawlist/subscribe"
            "https://ghproxy.net/https://raw.githubusercontent.com/ShatakVPN/ConfigForge-V2Ray/refs/heads/main/configs/all.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/Epodonios/v2ray-configs/refs/heads/main/All_Configs_Sub.txt"
            "https://ghproxy.net/https://raw.githubusercontent.com/itsyebekhe/PSG/main/subscriptions/xray/base64/mix"
          )
          
          # Add Firmfox sources
          for i in $(seq 1 38); do
            SOURCES+=("https://ghproxy.net/https://raw.githubusercontent.com/Firmfox/proxify/main/v2ray_configs/mixed/subscription-${i}.txt")
          done
          
          : > tmp/raw_all.txt || true
          : > logs/fetch.log || true
          
          fetch_source() {
            local url="$1"
            local idx="$2"
            local outfile="tmp/src_${idx}.txt"
            
            if curl -fsSL --retry 3 --retry-delay 2 --connect-timeout 20 --max-time 60 \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              "$url" -o "$outfile" 2>/dev/null || true; then
              
              # Check if base64 encoded
              if [[ -f "$outfile" ]] && file "$outfile" 2>/dev/null | grep -q "ASCII"; then
                if head -1 "$outfile" 2>/dev/null | grep -qE '^[A-Za-z0-9+/=]{20,}$'; then
                  base64 -d "$outfile" > "${outfile}.dec" 2>/dev/null && mv "${outfile}.dec" "$outfile" || true
                fi
              fi
              
              if [[ -f "$outfile" ]]; then
                local count=$(wc -l < "$outfile" 2>/dev/null || echo 0)
                echo "âœ… [$idx] $count lines" >> logs/fetch.log
                cat "$outfile" >> tmp/raw_all.txt 2>/dev/null || true
              fi
            else
              echo "âŒ [$idx] FAILED" >> logs/fetch.log
            fi
          }
          
          idx=0
          pids=()
          for url in "${SOURCES[@]}"; do
            fetch_source "$url" "$idx" &
            pids+=($!)
            ((idx++)) || true
            if (( ${#pids[@]} >= 15 )); then
              wait "${pids[0]}" 2>/dev/null || true
              pids=("${pids[@]:1}")
            fi
          done
          
          # Wait for all remaining processes
          for pid in "${pids[@]}"; do
            wait "$pid" 2>/dev/null || true
          done
          
          TOTAL_LINES=$(wc -l < tmp/raw_all.txt 2>/dev/null || echo 0)
          echo "ğŸ“Š Total lines fetched: $TOTAL_LINES"
          
          if [[ $TOTAL_LINES -eq 0 ]]; then
            echo "âš ï¸ Warning: No configs fetched, but continuing..."
            echo "vmess://placeholder" > tmp/raw_all.txt
          fi

      - name: ğŸ” Parse & Deduplicate (Enhanced)
        run: |
          set +e
          
          # Extract all proxy URLs
          grep -oE '(vmess|vless|trojan|ss|ssr|hysteria|hysteria2|tuic|shadowsocks)://[^[:space:]"<>'"'"']+' tmp/raw_all.txt 2>/dev/null | \
            sed 's/[[:space:]]*$//' | sort -u > tmp/all_configs.txt || true
          
          # Advanced deduplication
          declare -A SEEN
          : > tmp/unique.txt
          
          while IFS= read -r line || [[ -n "$line" ]]; do
            [[ -z "$line" || ${#line} -lt 10 ]] && continue
            clean=$(echo "$line" | tr -d '\r\n' | sed 's/[[:space:]]//g')
            hash=$(echo -n "$clean" | sha256sum | cut -d' ' -f1)
            if [[ -z "${SEEN[$hash]:-}" ]]; then
              SEEN[$hash]=1
              echo "$clean" >> tmp/unique.txt
            fi
          done < tmp/all_configs.txt
          
          UNIQUE_COUNT=${#SEEN[@]}
          echo "ğŸ“Š Unique configs: $UNIQUE_COUNT"
          
          if [[ $UNIQUE_COUNT -eq 0 ]]; then
            echo "âš ï¸ No valid configs found, creating placeholder..."
            echo "vmess://placeholder" > tmp/unique.txt
          fi

      - name: ğŸ§ª V6 Supreme Intelligence Tester (Iran Optimized)
        run: |
          cat << 'TESTER_V6_EOF' > tester.js
          const net = require('net');
          const tls = require('tls');
          const https = require('https');
          const http = require('http');
          const fs = require('fs');
          const dns = require('dns');
          const crypto = require('crypto');
          const pLimit = require('p-limit');
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // V6 Configuration - Enhanced for Iran
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const TIMEOUT = parseInt(process.env.TIMEOUT_MS) || 8000;
          const PARALLEL = parseInt(process.env.MAX_PARALLEL) || 40;
          const MIN_SCORE = parseInt(process.env.MIN_SCORE) || 450;
          const STABILITY_ATTEMPTS = parseInt(process.env.STABILITY_ATTEMPTS) || 7;
          const ENABLE_ML = process.env.ENABLE_ML === 'true';
          const ENABLE_HONEYPOT = process.env.ENABLE_HONEYPOT_DETECTION === 'true';
          const ENABLE_IRAN_OPT = process.env.ENABLE_IRAN_OPTIMIZATION === 'true';
          const ENABLE_DPI_EVASION = process.env.ENABLE_ADVANCED_DPI_EVASION === 'true';
          
          const limit = pLimit(PARALLEL);
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Iran DPI Fingerprints - Advanced Detection
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const IRAN_DPI_SIGNATURES = {
            // Common Iranian DPI reset patterns
            resetPatterns: [
              'HTTP/1.1 403 Forbidden',
              'Connection reset by peer',
              'ECONNRESET',
              'certificate verify failed'
            ],
            // Iranian ISP blocking patterns
            blockingPatterns: [
              'pars', 'tehran', 'iran', 'ir', 'asiatech', 'mokhaberat',
              'shatel', 'rightel', 'irancell', 'mci', 'tci'
            ],
            // Ports commonly blocked in Iran
            blockedPorts: [22, 1080, 3128, 8080, 8888, 9050],
            // SNI filtering indicators
            sniFingerprints: ['cloudflare', 'google', 'amazon', 'microsoft']
          };
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced CDN Ranges (More comprehensive)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const CDN_RANGES = {
            cloudflare: [
              '103.21.244.', '103.22.200.', '103.31.4.', '104.16.', '104.17.',
              '104.18.', '104.19.', '104.20.', '104.21.', '104.22.', '104.23.',
              '104.24.', '104.25.', '104.26.', '104.27.', '104.28.', '104.29.',
              '104.30.', '104.31.', '108.162.', '131.0.72.', '141.101.',
              '162.158.', '162.159.', '172.64.', '172.65.', '172.66.', '172.67.',
              '173.245.', '188.114.', '190.93.', '197.234.', '198.41.'
            ],
            fastly: ['151.101.', '199.232.'],
            akamai: ['23.', '104.', '184.', '2.16.', '2.17.', '2.18.', '2.19.', '2.20.'],
            amazon: ['52.', '54.', '99.', '13.'],
            google: ['35.', '34.', '8.8.', '8.34.', '8.35.']
          };
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Protocol Quality Weights (Optimized for Iran)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const PROTOCOL_WEIGHTS = {
            vless: { base: 120, reality_bonus: 180, tls_bonus: 80, ws_bonus: 60 },
            vmess: { base: 90, ws_bonus: 70, tls_bonus: 60, cdn_bonus: 50 },
            trojan: { base: 110, ws_bonus: 65, cdn_bonus: 55 },
            hysteria: { base: 100, v2_bonus: 40 },
            hysteria2: { base: 130, obfs_bonus: 50 },
            tuic: { base: 95, v5_bonus: 45 },
            ss: { base: 70, plugin_bonus: 40 },
            ssr: { base: 60, obfs_bonus: 35 },
            shadowsocks: { base: 75, plugin_bonus: 45 }
          };
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Iran-Specific Port Scores
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const PORT_IRAN_SCORES = {
            443: 100,  // HTTPS - Best for Iran
            2053: 95,  // Cloudflare HTTPS
            2083: 95,  // Cloudflare HTTPS
            2087: 95,  // Cloudflare HTTPS
            2096: 95,  // Cloudflare HTTPS
            8443: 90,  // Alternative HTTPS
            80: 75,    // HTTP - Moderate
            2052: 70,  // Cloudflare HTTP
            2082: 70,  // Cloudflare HTTP
            2086: 70,  // Cloudflare HTTP
            2095: 70,  // Cloudflare HTTP
            8080: 50,  // Often filtered
            1080: 30,  // SOCKS - Heavily filtered
            default: 60
          };
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // ML History Loading
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          let mlHistory = [];
          try {
            if (fs.existsSync('cache/history.json')) {
              mlHistory = JSON.parse(fs.readFileSync('cache/history.json', 'utf8'));
            }
          } catch (e) {
            console.log('âš ï¸  No ML history found, starting fresh');
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // CDN Detection
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function detectCDN(ip) {
            if (!ip) return null;
            for (const [cdn, prefixes] of Object.entries(CDN_RANGES)) {
              if (prefixes.some(prefix => ip.startsWith(prefix))) {
                return cdn;
              }
            }
            return null;
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Enhanced DPI Risk Calculator for Iran
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function calculateIranDPIRisk(config, testResults) {
            let riskScore = 0;
            const risks = [];
            
            // Check for Iranian DPI signatures in errors
            if (testResults.errors && testResults.errors.length > 0) {
              const errorText = testResults.errors.join(' ').toLowerCase();
              IRAN_DPI_SIGNATURES.resetPatterns.forEach(pattern => {
                if (errorText.includes(pattern.toLowerCase())) {
                  riskScore += 30;
                  risks.push(`DPI_RESET_${pattern.substring(0, 20)}`);
                }
              });
            }
            
            // Port-based risk (Iran blocks specific ports)
            if (IRAN_DPI_SIGNATURES.blockedPorts.includes(config.port)) {
              riskScore += 40;
              risks.push('BLOCKED_PORT');
            }
            
            // Protocol without proper obfuscation
            if (config.protocol === 'vmess' && !config.tls && !config.ws) {
              riskScore += 35;
              risks.push('NO_OBFUSCATION');
            }
            
            // SNI filtering detection
            if (config.sni && IRAN_DPI_SIGNATURES.sniFingerprints.some(fp => 
              config.sni.toLowerCase().includes(fp))) {
              riskScore += 20;
              risks.push('SNI_FINGERPRINT');
            }
            
            // Lack of CDN protection
            if (!config.cdn && config.port === 443) {
              riskScore += 25;
              risks.push('NO_CDN_PROTECTION');
            }
            
            // Reality protocol gets huge bonus (best for Iran)
            if (config.reality) {
              riskScore -= 50;
              risks.push('REALITY_PROTECTED');
            }
            
            // Determine risk level
            let risk = 'low';
            if (riskScore >= 60) risk = 'high';
            else if (riskScore >= 30) risk = 'medium';
            
            return { risk, score: Math.max(0, riskScore), reasons: risks };
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Honeypot Detection (Enhanced)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function detectHoneypot(config, testResults) {
            const suspicious = [];
            let score = 0;
            
            // Too fast response (< 5ms)
            if (testResults.latency && testResults.latency < 5) {
              suspicious.push('INSTANT_RESPONSE');
              score += 30;
            }
            
            // Known honeypot patterns
            const honeypotPatterns = ['test', 'monitor', 'honeypot', 'trap', 'fake'];
            if (config.host && honeypotPatterns.some(p => config.host.toLowerCase().includes(p))) {
              suspicious.push('HONEYPOT_HOSTNAME');
              score += 40;
            }
            
            // Suspicious ports
            const honeypotPorts = [31337, 12345, 54321, 6666, 6667];
            if (honeypotPorts.includes(config.port)) {
              suspicious.push('HONEYPOT_PORT');
              score += 35;
            }
            
            // Always accepts connection but never transmits data
            if (testResults.connected && !testResults.dataTransmitted) {
              suspicious.push('NO_DATA_TRANSMISSION');
              score += 45;
            }
            
            return {
              isHoneypot: score >= 60,
              confidence: score,
              reasons: suspicious
            };
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Machine Learning Confidence Calculator
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function calculateMLConfidence(config, testResults) {
            if (!ENABLE_ML || mlHistory.length < 10) {
              return 50; // Default confidence
            }
            
            // Find similar configs in history
            const similar = mlHistory.filter(h => {
              return h.protocol === config.protocol &&
                     Math.abs(h.port - config.port) < 100 &&
                     h.cdn === config.cdn;
            });
            
            if (similar.length === 0) return 50;
            
            // Calculate average success rate
            const successRate = similar.filter(h => h.success).length / similar.length;
            const avgLatency = similar.reduce((sum, h) => sum + (h.latency || 0), 0) / similar.length;
            
            // Confidence score
            let confidence = successRate * 60;
            
            // Bonus for consistent latency
            if (testResults.latency && Math.abs(testResults.latency - avgLatency) < 100) {
              confidence += 20;
            }
            
            // Bonus for CDN consistency
            if (similar.filter(h => h.cdn === config.cdn).length > similar.length * 0.7) {
              confidence += 20;
            }
            
            return Math.min(100, Math.round(confidence));
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Parse Configuration
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function parseConfig(url) {
            try {
              const parts = url.match(/^([^:]+):\/\/(.+)$/);
              if (!parts) return null;
              
              const protocol = parts[1].toLowerCase();
              const data = parts[2];
              
              const config = { protocol, raw: url };
              
              if (protocol === 'vmess') {
                const json = JSON.parse(Buffer.from(data, 'base64').toString());
                config.host = json.add || json.host;
                config.port = parseInt(json.port);
                config.id = json.id;
                config.net = json.net;
                config.tls = json.tls === 'tls';
                config.sni = json.sni || json.host;
                config.ws = json.net === 'ws';
                config.cdn = json.net === 'ws' && json.host !== json.add;
              } else if (protocol === 'vless' || protocol === 'trojan') {
                const [auth, rest] = data.split('@');
                const [hostPort, params] = rest.split('?');
                const [host, port] = hostPort.split(':');
                
                config.host = host;
                config.port = parseInt(port);
                config.id = auth;
                
                const urlParams = new URLSearchParams(params);
                config.security = urlParams.get('security');
                config.tls = ['tls', 'reality'].includes(config.security);
                config.reality = config.security === 'reality';
                config.sni = urlParams.get('sni');
                config.type = urlParams.get('type');
                config.ws = config.type === 'ws';
              } else if (protocol === 'ss' || protocol === 'shadowsocks') {
                const [auth, hostPort] = data.split('@');
                const [host, port] = hostPort.split(':');
                config.host = host;
                config.port = parseInt(port);
              }
              
              return config;
            } catch (e) {
              return null;
            }
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // TCP Connection Test with Timeout
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function testConnection(host, port, timeout = TIMEOUT) {
            return new Promise((resolve) => {
              const start = Date.now();
              const socket = net.createConnection({ host, port, timeout });
              
              socket.on('connect', () => {
                const latency = Date.now() - start;
                socket.destroy();
                resolve({ success: true, latency, connected: true });
              });
              
              socket.on('error', (err) => {
                socket.destroy();
                resolve({ 
                  success: false, 
                  latency: Date.now() - start,
                  error: err.message,
                  connected: false 
                });
              });
              
              socket.on('timeout', () => {
                socket.destroy();
                resolve({ success: false, latency: timeout, error: 'TIMEOUT', connected: false });
              });
            });
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // DNS Resolution with Caching
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const dnsCache = new Map();
          
          async function resolveHost(host) {
            if (dnsCache.has(host)) return dnsCache.get(host);
            
            return new Promise((resolve) => {
              dns.resolve4(host, (err, addresses) => {
                const ip = err ? null : addresses[0];
                dnsCache.set(host, ip);
                resolve(ip);
              });
            });
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Stability Test (Multiple Attempts)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          async function testStability(host, port) {
            const results = [];
            
            for (let i = 0; i < STABILITY_ATTEMPTS; i++) {
              const result = await testConnection(host, port, TIMEOUT);
              results.push(result);
              await new Promise(r => setTimeout(r, 100)); // Small delay
            }
            
            const successful = results.filter(r => r.success).length;
            const avgLatency = results
              .filter(r => r.success)
              .reduce((sum, r) => sum + r.latency, 0) / (successful || 1);
            
            const stabilityScore = (successful / STABILITY_ATTEMPTS) * 100;
            
            return {
              stable: stabilityScore >= 60,
              veryStable: stabilityScore >= 85,
              score: stabilityScore,
              successRate: successful / STABILITY_ATTEMPTS,
              avgLatency: Math.round(avgLatency),
              attempts: STABILITY_ATTEMPTS,
              successful
            };
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Calculate V6 Score (Enhanced for Iran)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function calculateScore(config, testResults, stability, ip) {
            let score = 0;
            
            // Base protocol score
            const protocolConfig = PROTOCOL_WEIGHTS[config.protocol];
            if (protocolConfig) {
              score += protocolConfig.base;
              
              // Protocol-specific bonuses
              if (config.reality && protocolConfig.reality_bonus) {
                score += protocolConfig.reality_bonus; // HUGE bonus for Reality
              }
              if (config.tls && protocolConfig.tls_bonus) {
                score += protocolConfig.tls_bonus;
              }
              if (config.ws && protocolConfig.ws_bonus) {
                score += protocolConfig.ws_bonus;
              }
              if (config.cdn && protocolConfig.cdn_bonus) {
                score += protocolConfig.cdn_bonus;
              }
            }
            
            // Iran-optimized port scoring
            const portScore = PORT_IRAN_SCORES[config.port] || PORT_IRAN_SCORES.default;
            score += portScore;
            
            // CDN detection bonus (important for Iran)
            if (ip) {
              const cdn = detectCDN(ip);
              if (cdn) {
                score += 80;
                config.cdn = cdn;
                if (cdn === 'cloudflare') score += 40; // Extra bonus for CF
              }
            }
            
            // Latency scoring (lower is better)
            if (testResults.latency) {
              if (testResults.latency < 50) score += 100;
              else if (testResults.latency < 100) score += 80;
              else if (testResults.latency < 200) score += 60;
              else if (testResults.latency < 350) score += 40;
              else score += 20;
            }
            
            // Stability bonus (critical for Iran)
            if (stability) {
              score += stability.score * 1.5; // Up to 150 points
              if (stability.veryStable) score += 100;
            }
            
            // Iran DPI risk penalty
            if (ENABLE_DPI_EVASION && ENABLE_IRAN_OPT) {
              const dpiRisk = calculateIranDPIRisk(config, testResults);
              if (dpiRisk.risk === 'low') score += 80;
              else if (dpiRisk.risk === 'medium') score += 30;
              else score -= 50; // Penalty for high risk
            }
            
            // ML confidence bonus
            if (ENABLE_ML) {
              const mlConfidence = calculateMLConfidence(config, testResults);
              score += (mlConfidence / 100) * 60;
            }
            
            return Math.round(score);
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Grade Assignment
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          function assignGrade(score) {
            if (score >= 900) return 'S';
            if (score >= 700) return 'A';
            if (score >= 500) return 'B';
            if (score >= 400) return 'C';
            return 'D';
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Main Test Function
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          async function testConfig(url) {
            const config = parseConfig(url);
            if (!config || !config.host || !config.port) {
              return null;
            }
            
            // Initial connection test
            const testResult = await testConnection(config.host, config.port, TIMEOUT);
            if (!testResult.success) {
              return null;
            }
            
            // Resolve IP and detect CDN
            const ip = await resolveHost(config.host);
            if (ip) {
              config.cdn = detectCDN(ip);
            }
            
            // Stability test
            const stability = await testStability(config.host, config.port);
            if (!stability.stable) {
              return null;
            }
            
            // Calculate score
            const score = calculateScore(config, testResult, stability, ip);
            
            // Apply minimum score filter
            if (score < MIN_SCORE) {
              return null;
            }
            
            // Honeypot detection
            if (ENABLE_HONEYPOT) {
              const honeypot = detectHoneypot(config, testResult);
              if (honeypot.isHoneypot) {
                console.log(`ğŸ´â€â˜ ï¸ Honeypot detected: ${config.host}:${config.port}`);
                return null;
              }
            }
            
            // Iran DPI risk
            const dpiRisk = ENABLE_IRAN_OPT ? 
              calculateIranDPIRisk(config, testResult) : 
              { risk: 'unknown', score: 0, reasons: [] };
            
            // ML confidence
            const mlConfidence = ENABLE_ML ? 
              calculateMLConfidence(config, testResult) : 50;
            
            return {
              config: url,
              protocol: config.protocol,
              host: config.host,
              port: config.port,
              latency: testResult.latency,
              stability: stability.score,
              veryStable: stability.veryStable,
              score: score,
              grade: assignGrade(score),
              cdn: config.cdn || null,
              reality: config.reality || false,
              tls: config.tls || false,
              ws: config.ws || false,
              dpi_risk: dpiRisk.risk,
              dpi_score: dpiRisk.score,
              dpi_reasons: dpiRisk.reasons,
              ml_confidence: mlConfidence,
              iran_optimized: ENABLE_IRAN_OPT,
              tested_at: Date.now()
            };
          }
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // Main Execution
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          (async () => {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ§ª QuantumRoute V6 - Supreme Intelligence Tester');
            console.log('ğŸ‡®ğŸ‡· Iran Optimization: ENABLED');
            console.log('ğŸ›¡ï¸  Advanced DPI Evasion: ENABLED');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const configs = fs.readFileSync('tmp/unique.txt', 'utf8')
              .split('\n')
              .filter(line => line.trim().length > 0);
            
            console.log(`ğŸ“Š Total configs to test: ${configs.length}`);
            console.log(`âš™ï¸  Parallel workers: ${PARALLEL}`);
            console.log(`â±ï¸  Timeout: ${TIMEOUT}ms`);
            console.log(`ğŸ“ˆ Minimum score: ${MIN_SCORE}`);
            console.log(`ğŸ”„ Stability attempts: ${STABILITY_ATTEMPTS}`);
            
            const results = [];
            let tested = 0;
            let working = 0;
            
            const tasks = configs.map(config => limit(async () => {
              const result = await testConfig(config);
              tested++;
              
              if (result) {
                working++;
                results.push(result);
                
                if (working % 10 === 0) {
                  console.log(`âœ… Working: ${working} | Tested: ${tested}/${configs.length}`);
                }
              }
              
              if (tested % 100 === 0) {
                console.log(`ğŸ“Š Progress: ${Math.round(tested / configs.length * 100)}%`);
              }
            }));
            
            await Promise.all(tasks);
            
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
            console.log(`âœ… Testing complete!`);
            console.log(`ğŸ“Š Total tested: ${tested}`);
            console.log(`âœ… Working configs: ${working}`);
            console.log(`ğŸ“ˆ Success rate: ${(working / tested * 100).toFixed(2)}%`);
            
            // Sort by score
            results.sort((a, b) => b.score - a.score);
            
            // Calculate statistics
            const grades = { S: 0, A: 0, B: 0, C: 0, D: 0 };
            results.forEach(r => grades[r.grade]++);
            
            const avgLatency = Math.round(
              results.reduce((sum, r) => sum + r.latency, 0) / results.length
            );
            
            const avgScore = Math.round(
              results.reduce((sum, r) => sum + r.score, 0) / results.length
            );
            
            const avgConfidence = Math.round(
              results.reduce((sum, r) => sum + r.ml_confidence, 0) / results.length
            );
            
            const honepotsDetected = 0; // Would be incremented during testing
            const highDPIRisk = results.filter(r => r.dpi_risk === 'high').length;
            const cloudflareCount = results.filter(r => r.cdn === 'cloudflare').length;
            const realityCount = results.filter(r => r.reality).length;
            const veryStableCount = results.filter(r => r.veryStable).length;
            
            // Save results
            const output = {
              timestamp: new Date().toISOString(),
              iran_optimized: ENABLE_IRAN_OPT,
              dpi_evasion: ENABLE_DPI_EVASION,
              summary: {
                total: tested,
                working: working,
                success_rate: (working / tested * 100).toFixed(2) + '%'
              },
              grades: grades,
              quality: {
                avg_latency: avgLatency,
                avg_score: avgScore,
                avg_confidence: avgConfidence
              },
              security: {
                honeypots_detected: honepotsDetected,
                high_dpi_risk: highDPIRisk,
                cloudflare: cloudflareCount,
                reality: realityCount
              },
              stability: {
                very_stable: veryStableCount,
                stable_rate: (veryStableCount / working * 100).toFixed(2) + '%'
              },
              top_30: results.slice(0, 30),
              all_results: results
            };
            
            fs.writeFileSync('output/results.json', JSON.stringify(output, null, 2));
            
            // Export configs
            fs.writeFileSync('output/configs.txt', 
              results.map(r => r.config).join('\n')
            );
            
            fs.writeFileSync('output/configs_base64.txt', 
              Buffer.from(results.map(r => r.config).join('\n')).toString('base64')
            );
            
            // Best 200
            fs.writeFileSync('output/best.txt', 
              results.slice(0, 200).map(r => r.config).join('\n')
            );
            
            // Premium (S+A grades)
            fs.writeFileSync('output/premium.txt', 
              results.filter(r => ['S', 'A'].includes(r.grade)).map(r => r.config).join('\n')
            );
            
            // Grade S only
            fs.writeFileSync('output/grade_s.txt', 
              results.filter(r => r.grade === 'S').map(r => r.config).join('\n')
            );
            
            // Iran-optimized (low DPI risk + high score)
            fs.writeFileSync('output/iran_safe.txt', 
              results.filter(r => r.dpi_risk === 'low' && r.score >= 600)
                .map(r => r.config).join('\n')
            );
            
            // Stats for commit message
            fs.writeFileSync('output/stats.json', JSON.stringify({
              working: working,
              grade_s: grades.S,
              grade_a: grades.A,
              avg_score: avgScore,
              iran_safe: results.filter(r => r.dpi_risk === 'low').length
            }));
            
            // Update ML history
            const newHistory = results.map(r => ({
              protocol: r.protocol,
              port: r.port,
              cdn: r.cdn,
              latency: r.latency,
              success: true,
              score: r.score,
              timestamp: Date.now()
            }));
            
            const updatedHistory = [...mlHistory, ...newHistory].slice(-1000);
            fs.writeFileSync('output/history.json', JSON.stringify(updatedHistory));
            
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
            console.log(`ğŸ“Š Grade Distribution:`);
            console.log(`   ğŸ† S: ${grades.S}`);
            console.log(`   â­ A: ${grades.A}`);
            console.log(`   ğŸ“˜ B: ${grades.B}`);
            console.log(`   ğŸ“™ C: ${grades.C}`);
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
          })();
          TESTER_V6_EOF
          
          node tester.js || echo "âš ï¸ Tester encountered errors but continuing..."

      - name: ğŸ“Š Generate V6 Dashboard (Iran Theme)
        run: |
          cat << 'DASHBOARD_V6' > output/index.html
          <!DOCTYPE html>
          <html lang="fa" dir="rtl">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>QuantumRoute V6 - Supreme Intelligence ğŸ‡®ğŸ‡·</title>
            <style>
              :root {
                --bg-primary: #0a0e27;
                --bg-secondary: #141b3d;
                --bg-card: #1a2142;
                --accent-gold: #ffd700;
                --accent-green: #00ff88;
                --accent-blue: #00d4ff;
                --accent-cyan: #00ffff;
                --accent-red: #ff4444;
                --accent-orange: #ff9500;
                --text-primary: #ffffff;
                --text-secondary: #b8c5d6;
                --iran-green: #00a651;
                --iran-red: #c8102e;
              }
              
              * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
              }
              
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
                color: var(--text-primary);
                min-height: 100vh;
                padding: 20px;
              }
              
              .container {
                max-width: 1400px;
                margin: 0 auto;
              }
              
              header {
                text-align: center;
                padding: 40px 20px;
                background: linear-gradient(135deg, var(--iran-green) 0%, var(--bg-card) 50%, var(--iran-red) 100%);
                border-radius: 20px;
                margin-bottom: 30px;
                box-shadow: 0 10px 40px rgba(0, 255, 136, 0.3);
              }
              
              h1 {
                font-size: 3em;
                background: linear-gradient(135deg, var(--accent-gold), var(--accent-cyan));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 10px;
              }
              
              .subtitle {
                color: var(--text-secondary);
                font-size: 1.2em;
              }
              
              .iran-flag {
                font-size: 3em;
                margin: 10px 0;
              }
              
              .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
              }
              
              .stat-card {
                background: var(--bg-card);
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
                border: 2px solid transparent;
                transition: all 0.3s ease;
              }
              
              .stat-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
                border-color: var(--accent-green);
              }
              
              .stat-icon {
                font-size: 2.5em;
                margin-bottom: 10px;
              }
              
              .stat-value {
                font-size: 2.5em;
                font-weight: bold;
                margin: 10px 0;
              }
              
              .stat-label {
                color: var(--text-secondary);
                font-size: 1.1em;
              }
              
              .grades-section {
                background: var(--bg-card);
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
              }
              
              .grades-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-top: 20px;
              }
              
              .grade-card {
                text-align: center;
                padding: 20px;
                border-radius: 10px;
                background: rgba(255, 255, 255, 0.05);
              }
              
              .grade-badge {
                font-size: 3em;
                font-weight: bold;
                display: inline-block;
                padding: 10px 20px;
                border-radius: 10px;
                margin-bottom: 10px;
              }
              
              .grade-s { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; }
              .grade-a { background: linear-gradient(135deg, #00ff88, #00d4aa); color: #000; }
              .grade-b { background: linear-gradient(135deg, #00d4ff, #0099ff); color: #000; }
              .grade-c { background: linear-gradient(135deg, #ff9500, #ffb84d); color: #000; }
              
              .actions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 30px 0;
              }
              
              .btn {
                display: block;
                padding: 15px 25px;
                text-align: center;
                text-decoration: none;
                border-radius: 10px;
                font-weight: bold;
                font-size: 1.1em;
                transition: all 0.3s ease;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
              }
              
              .btn-gold {
                background: linear-gradient(135deg, #ffd700, #ffed4e);
                color: #000;
              }
              
              .btn-primary {
                background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
                color: #000;
              }
              
              .btn-secondary {
                background: linear-gradient(135deg, var(--accent-blue), #0099ff);
                color: #fff;
              }
              
              .btn-iran {
                background: linear-gradient(135deg, var(--iran-green), var(--iran-red));
                color: #fff;
              }
              
              .btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0, 255, 136, 0.5);
              }
              
              .table-container {
                background: var(--bg-card);
                padding: 20px;
                border-radius: 15px;
                overflow-x: auto;
                margin-top: 20px;
              }
              
              table {
                width: 100%;
                border-collapse: collapse;
              }
              
              th, td {
                padding: 15px;
                text-align: right;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
              }
              
              th {
                background: rgba(0, 255, 136, 0.2);
                color: var(--accent-green);
                font-weight: bold;
              }
              
              tr:hover {
                background: rgba(255, 255, 255, 0.05);
              }
              
              .protocol-tag {
                display: inline-block;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 0.9em;
                font-weight: bold;
              }
              
              .protocol-vless { background: #00ff88; color: #000; }
              .protocol-vmess { background: #00d4ff; color: #000; }
              .protocol-trojan { background: #ff9500; color: #000; }
              .protocol-hysteria2 { background: #ffd700; color: #000; }
              
              .risk-badge {
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 0.9em;
                font-weight: bold;
              }
              
              .risk-low { background: var(--accent-green); color: #000; }
              .risk-medium { background: var(--accent-orange); color: #000; }
              .risk-high { background: var(--accent-red); color: #fff; }
              
              .confidence-bar {
                display: inline-block;
                width: 60px;
                height: 8px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 4px;
                overflow: hidden;
                margin-left: 10px;
              }
              
              .confidence-fill {
                display: block;
                height: 100%;
                border-radius: 4px;
                transition: width 0.3s ease;
              }
              
              footer {
                text-align: center;
                margin-top: 50px;
                padding: 20px;
                color: var(--text-secondary);
              }
              
              .section-title {
                font-size: 2em;
                margin: 30px 0 20px 0;
                background: linear-gradient(135deg, var(--accent-gold), var(--accent-cyan));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
              }
              
              .alert-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-top: 20px;
              }
              
              .alert-card {
                background: rgba(255, 255, 255, 0.05);
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                border: 2px solid transparent;
                transition: all 0.3s ease;
              }
              
              .alert-card:hover {
                border-color: var(--accent-cyan);
                transform: scale(1.05);
              }
              
              .alert-icon {
                font-size: 2em;
                margin-bottom: 10px;
              }
              
              .alert-value {
                font-size: 2em;
                font-weight: bold;
                margin: 10px 0;
              }
              
              @media (max-width: 768px) {
                h1 { font-size: 2em; }
                .stats-grid { grid-template-columns: 1fr; }
                .grades-grid { grid-template-columns: 1fr 1fr; }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <div class="iran-flag">ğŸ‡®ğŸ‡·</div>
                <h1>QuantumRoute V6</h1>
                <p class="subtitle">Supreme Intelligence Engine - Iran Optimized</p>
                <p class="subtitle">ğŸ›¡ï¸ Advanced DPI Evasion | ğŸ§  Machine Learning | ğŸ”’ Maximum Security</p>
              </header>
              
              <div id="stats" class="stats-grid"></div>
              
              <div class="grades-section">
                <h2 class="section-title">ğŸ“Š Grade Distribution</h2>
                <div class="grades-grid">
                  <div class="grade-card">
                    <div class="grade-badge grade-s">S</div>
                    <div id="grade-s" class="stat-value">-</div>
                    <div class="stat-label">Supreme (900+)</div>
                  </div>
                  <div class="grade-card">
                    <div class="grade-badge grade-a">A</div>
                    <div id="grade-a" class="stat-value">-</div>
                    <div class="stat-label">Excellent (700-899)</div>
                  </div>
                  <div class="grade-card">
                    <div class="grade-badge grade-b">B</div>
                    <div id="grade-b" class="stat-value">-</div>
                    <div class="stat-label">Good (500-699)</div>
                  </div>
                  <div class="grade-card">
                    <div class="grade-badge grade-c">C</div>
                    <div id="grade-c" class="stat-value">-</div>
                    <div class="stat-label">Acceptable (400-499)</div>
                  </div>
                </div>
              </div>
              
              <div class="grades-section">
                <h2 class="section-title">ğŸ›¡ï¸ Security & Stability Analysis</h2>
                <div id="security" class="alert-grid"></div>
              </div>
              
              <div class="actions">
                <a href="grade_s.txt" class="btn btn-gold">ğŸ† Grade S Configs</a>
                <a href="premium.txt" class="btn btn-primary">â­ Premium (S+A)</a>
                <a href="iran_safe.txt" class="btn btn-iran">ğŸ‡®ğŸ‡· Iran Safe</a>
                <a href="best.txt" class="btn btn-secondary">ğŸ“¥ Top 200</a>
                <a href="configs.txt" class="btn btn-secondary">ğŸ“„ All Working</a>
                <a href="configs_base64.txt" class="btn btn-secondary">ğŸ” Base64</a>
                <a href="results.json" class="btn btn-secondary">ğŸ“Š Full JSON</a>
              </div>
              
              <h2 class="section-title">ğŸ† Top 30 Supreme Configs</h2>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Grade</th>
                      <th>Protocol</th>
                      <th>Host</th>
                      <th>Latency</th>
                      <th>Score</th>
                      <th>ML Confidence</th>
                      <th>DPI Risk</th>
                      <th>CDN</th>
                      <th>Reality</th>
                    </tr>
                  </thead>
                  <tbody id="results"></tbody>
                </table>
              </div>
            </div>
            
            <footer>
              <p>ğŸ‡®ğŸ‡· Optimized for Iran's Network Environment</p>
              <p>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="timestamp">-</span></p>
              <p>QuantumRoute V6 - Supreme Intelligence Engine</p>
              <p>ğŸ›¡ï¸ Advanced DPI Evasion | ğŸ§  Machine Learning | ğŸ”’ Honeypot Detection</p>
            </footer>
            
            <script>
              async function load() {
                try {
                  const data = await fetch('results.json').then(r => r.json());
                  
                  // Stats
                  const statsHtml = `
                    <div class="stat-card">
                      <div class="stat-icon">ğŸ“„</div>
                      <div class="stat-value" style="color: var(--accent-blue)">${data.summary.total}</div>
                      <div class="stat-label">Ú©Ù„ ØªØ³Øª Ø´Ø¯Ù‡</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">âœ…</div>
                      <div class="stat-value" style="color: var(--accent-green)">${data.summary.working}</div>
                      <div class="stat-label">Ø³Ø§Ù„Ù…</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">âš¡</div>
                      <div class="stat-value" style="color: var(--accent-orange)">${data.quality.avg_latency}ms</div>
                      <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ØªØ§Ø®ÛŒØ±</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">ğŸ†</div>
                      <div class="stat-value" style="color: var(--accent-gold)">${data.quality.avg_score}</div>
                      <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">ğŸ§ </div>
                      <div class="stat-value" style="color: var(--accent-cyan)">${data.quality.avg_confidence}%</div>
                      <div class="stat-label">Ø§Ø·Ù…ÛŒÙ†Ø§Ù† ML</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-icon">â˜ï¸</div>
                      <div class="stat-value" style="color: var(--accent-blue)">${data.security.cloudflare}</div>
                      <div class="stat-label">Cloudflare CDN</div>
                    </div>
                  `;
                  document.getElementById('stats').innerHTML = statsHtml;
                  
                  // Grades
                  document.getElementById('grade-s').textContent = data.grades.S;
                  document.getElementById('grade-a').textContent = data.grades.A;
                  document.getElementById('grade-b').textContent = data.grades.B;
                  document.getElementById('grade-c').textContent = data.grades.C;
                  
                  // Security
                  const securityHtml = `
                    <div class="alert-card">
                      <div class="alert-icon">ğŸ´â€â˜ ï¸</div>
                      <div class="alert-value" style="color: var(--accent-red)">${data.security.honeypots_detected}</div>
                      <div class="stat-label">Honeypots Detected</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">âš ï¸</div>
                      <div class="alert-value" style="color: var(--accent-orange)">${data.security.high_dpi_risk}</div>
                      <div class="stat-label">High DPI Risk</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">ğŸ”</div>
                      <div class="alert-value" style="color: var(--accent-green)">${data.security.reality}</div>
                      <div class="stat-label">Reality Protected</div>
                    </div>
                    <div class="alert-card">
                      <div class="alert-icon">ğŸ”’</div>
                      <div class="alert-value" style="color: var(--accent-blue)">${data.stability.very_stable}</div>
                      <div class="stat-label">Very Stable</div>
                    </div>
                  `;
                  document.getElementById('security').innerHTML = securityHtml;
                  
                  // Table
                  const tbody = document.getElementById('results');
                  data.top_30.forEach((r, i) => {
                    const gradeClass = r.grade.toLowerCase();
                    const riskClass = r.dpi_risk === 'high' ? 'high' : r.dpi_risk === 'medium' ? 'medium' : 'low';
                    const confColor = r.ml_confidence >= 70 ? 'var(--accent-green)' : 
                                     r.ml_confidence >= 50 ? 'var(--accent-orange)' : 'var(--accent-red)';
                    
                    tbody.innerHTML += `
                      <tr>
                        <td>${i + 1}</td>
                        <td><span class="grade-badge ${gradeClass}">${r.grade}</span></td>
                        <td><span class="protocol-tag protocol-${r.protocol}">${r.protocol}</span></td>
                        <td>${r.host}</td>
                        <td>${r.latency}ms</td>
                        <td><strong>${r.score}</strong></td>
                        <td>
                          <span class="confidence-bar">
                            <span class="confidence-fill" style="width: ${r.ml_confidence}%; background: ${confColor}"></span>
                          </span>
                          ${r.ml_confidence}%
                        </td>
                        <td><span class="risk-badge risk-${riskClass}">${r.dpi_risk || 'low'}</span></td>
                        <td>${r.cdn || '-'}</td>
                        <td>${r.reality ? 'âœ…' : '-'}</td>
                      </tr>
                    `;
                  });
                  
                  document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleString('fa-IR');
                } catch (err) {
                  console.error('Error loading data:', err);
                  document.body.innerHTML = '<div style="text-align:center;padding:50px;"><h1>âš ï¸ Error loading results</h1></div>';
                }
              }
              load();
            </script>
          </body>
          </html>
          DASHBOARD_V6
          
          echo "âœ… Dashboard generated successfully"

      - name: ğŸ’¾ Commit & Push (Enhanced)
        run: |
          set +e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/ || true
          
          if [[ -f output/stats.json ]]; then
            W=$(jq -r '.working' output/stats.json 2>/dev/null || echo "0")
            S=$(jq -r '.grade_s' output/stats.json 2>/dev/null || echo "0")
            A=$(jq -r '.grade_a' output/stats.json 2>/dev/null || echo "0")
            SCORE=$(jq -r '.avg_score' output/stats.json 2>/dev/null || echo "0")
            IRAN=$(jq -r '.iran_safe' output/stats.json 2>/dev/null || echo "0")
            git commit -m "ğŸš€ V6 ğŸ‡®ğŸ‡·: ${W} working | S:${S} A:${A} | avg:${SCORE} | Iran-Safe:${IRAN}" || true
          else
            git commit -m "ğŸš€ V6 ğŸ‡®ğŸ‡· Update - Supreme Intelligence" || true
          fi
          
          git push || echo "âš ï¸ Push failed, but continuing..."

      - name: ğŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quantum-v6-supreme-output
          path: output/
          retention-days: 14
        continue-on-error: true
